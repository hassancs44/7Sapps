<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ© | SEVENS</title>

  <!-- Ø®Ø·ÙˆØ· ÙˆØ£ÙŠÙ‚ÙˆÙ†Ø§Øª -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    :root{
      --blue-50:#e3f2fd; --blue-100:#bbdefb; --blue-200:#90caf9; --blue-300:#64b5f6;
      --blue-400:#42a5f5; --blue-500:#2196f3; --blue-600:#1e88e5; --blue-700:#1976d2;
      --sky:#f8fbff; --ink:#2c3e50; --muted:#607d8b; --line:#eef5ff;
      --green:#43a047; --red:#e53935; --amber:#ffb300; --shadow: rgba(0,0,0,.06);
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Tajawal',sans-serif}
    body{background:var(--sky);color:var(--ink);min-height:100vh}

    /* Navbar */
    .navbar{
      background:#fff;padding:16px 24px;display:flex;justify-content:space-between;align-items:center;
      box-shadow:0 2px 12px var(--shadow);position:sticky;top:0;z-index:100
    }
    .logo-box{display:flex;align-items:center;gap:12px}
    .logo-box img{width:40px;height:40px;object-fit:contain;border-radius:10px}
    .logo-box h1{color:var(--blue-600);font-size:20px;font-weight:700}
    .user-info{display:flex;align-items:center;gap:12px;color:#34495e;font-weight:600}
    .logout-btn{background:#e3f2fd;color:#1976d2;border:none;padding:6px 14px;border-radius:8px;font-weight:600;cursor:pointer}
    .logout-btn:hover{background:#bbdefb}

    .container{max-width:1220px;margin:24px auto;padding:0 16px}

    /* Tabs */
    .tabs{display:flex;gap:10px;margin-bottom:18px;flex-wrap:wrap}
    .tab-btn{padding:10px 14px;border:2px solid var(--blue-50);border-radius:10px;background:#fff;color:#1565c0;font-weight:700;cursor:pointer}
    .tab-btn.active{background:linear-gradient(90deg,var(--blue-500),var(--blue-700));color:#fff;border-color:transparent}
    .tab{display:none}
    .tab.active{display:block}

    .section-title{font-size:22px;color:var(--blue-600);margin:20px 0 12px;padding-bottom:10px;border-bottom:2px solid var(--blue-50);display:flex;align-items:center;gap:10px}

    /* Filters & Buttons */
    .filters{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    .form-control{padding:10px;border:2px solid var(--blue-50);border-radius:10px;background:#fff}
    .btn{padding:10px 14px;border:none;border-radius:10px;font-weight:700;cursor:pointer}
    .btn-primary{background:linear-gradient(90deg,var(--blue-500),var(--blue-700));color:#fff}
    .btn-green{background:var(--green);color:#fff}
    .btn-danger{background:var(--red);color:#fff}
    .btn-outline{background:#fff;border:2px solid var(--blue-50);color:#1565c0}

    /* Requests grid (cards) */
    .requests-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:18px}
    .request-card{background:#fff;border-radius:18px;border:1px solid #e3f2fd;box-shadow:0 4px 10px rgba(0,0,0,.08);transition:.3s;text-align:right;aspect-ratio:1/1;padding:18px;display:flex;flex-direction:column;justify-content:space-between;position:relative}
    .request-card:hover{transform:translateY(-5px);box-shadow:0 8px 20px rgba(30,136,229,.18)}

    .status-header{height:6px}
    .status-new{background:#2196f3}
    .status-in-progress{background:#ff9800}
    .status-closed{background:#4caf50}
    .status-rejected{background:#f44336}
    .card-content{padding:18px}
    .request-title{font-size:18px;margin:8px 0 10px;color:#0d47a1;font-weight:700}
    .request-meta{display:flex;flex-wrap:wrap;gap:12px;color:#455a64;font-size:14px;margin-bottom:10px}
    .status-badge{display:inline-block;padding:4px 10px;border-radius:16px;font-size:12px;color:#fff}
    .no-requests{text-align:center;color:#7f8c8d;padding:18px}

    /* Users table */
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    thead th{background:#eaf3ff;color:#0d47a1;padding:10px;border-radius:10px;font-size:14px}
    tbody td{background:#fff;padding:10px;border:1px solid var(--line)}
    tbody tr{box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .action-btns{display:flex;gap:6px;flex-wrap:wrap}

    /* Modal (generic) */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);justify-content:center;align-items:center;z-index:2000}
    .modal-content{background:#fff;width:90%;max-width:560px;border-radius:16px;padding:20px 18px}
    .modal h3{margin-bottom:10px;color:#1565c0}
    .modal .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .modal .row .col{display:flex;flex-direction:column;gap:6px}
    label{font-size:13px;color:#455a64;font-weight:700}

    /* File viewer modal + Ticket details */
    .file-viewer-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);justify-content:center;align-items:center;z-index:3000;padding:20px}
    .file-viewer-content{background:#fff;border-radius:16px;padding:20px;max-width:900px;width:100%;max-height:90vh;overflow:auto;position:relative;box-shadow:0 10px 30px rgba(0,0,0,.3)}
    .file-viewer-body{text-align:initial}
    .close-btn{position:absolute;top:10px;left:15px;font-size:26px;cursor:pointer;color:#444;transition:.2s}
    .close-btn:hover{color:#e53935}

    /* New Request Modal */
    .request-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);justify-content:center;align-items:center;z-index:2200}
    .request-modal-content{background:#fff;border-radius:20px;padding:25px 30px;width:95%;max-width:520px;box-shadow:0 10px 30px rgba(0,0,0,.25);text-align:right;animation:fadeIn .25s ease}
    .request-modal-content h3{text-align:center;font-size:20px;color:#1565c0;margin-bottom:20px;font-weight:700}
    .request-modal-content .form-group{display:flex;flex-direction:column;margin-bottom:15px}
    .request-modal-content label{font-size:14px;color:#37474f;font-weight:600;margin-bottom:5px}
    .request-modal-content input,.request-modal-content textarea,.request-modal-content select{border:2px solid #e3f2fd;border-radius:10px;padding:10px;font-size:15px;outline:none;transition:.2s;background:#f9fbff}
    .request-modal-content input:focus,.request-modal-content textarea:focus,.request-modal-content select:focus{border-color:#64b5f6;box-shadow:0 0 0 2px rgba(33,150,243,.15)}
    .submit-btn{width:100%;padding:12px;background:linear-gradient(90deg,#2196f3,#1976d2);color:#fff;border:none;border-radius:12px;font-weight:700;font-size:16px;cursor:pointer}
    .submit-btn:hover{background:linear-gradient(90deg,#1976d2,#0d47a1)}

    /* Chat inline */
    .chat-msg{margin-bottom:12px;padding:10px 14px;border-radius:14px;max-width:85%;word-wrap:break-word;position:relative;font-size:14px;line-height:1.6;animation:fadeIn .3s ease}
    .chat-msg.me{margin-left:auto;background:#e3f2fd;color:#0d47a1;border-top-right-radius:0;box-shadow:0 3px 6px rgba(33,150,243,.2)}
    .chat-msg.other{margin-right:auto;background:#e8f5e9;color:#1b5e20;border-top-left-radius:0;box-shadow:0 3px 6px rgba(76,175,80,.2)}
    .chat-meta{font-size:12px;color:#607d8b;margin-bottom:4px;display:flex;justify-content:space-between}
    .chat-attachment a{color:#1565c0;font-weight:700;text-decoration:none}
    .chat-attachment a:hover{text-decoration:underline}

    /* Timer + status */
    .update-section{display:flex;gap:10px;align-items:center;margin-top:10px;background:#f9fbfd;padding:10px 12px;border-radius:10px}
    .status-select{padding:8px 10px;border:2px solid #e3f2fd;border-radius:8px;font-weight:700;color:var(--blue-600);background:#fff;cursor:pointer}
    .timer-text{display:inline-block;min-width:80px;padding:5px 8px;border-radius:6px;font-weight:700;font-size:14px;text-align:center;color:#333;background:#f1f8e9;border:1px solid #c8e6c9}

    /* Dropdown (departments) */
    .custom-dropdown{position:relative;width:260px}
    .dropdown-selected{background:#fff;border:2px solid var(--blue-50);border-radius:10px;padding:10px 14px;display:flex;justify-content:space-between;align-items:center;color:#0d47a1;cursor:pointer;box-shadow:0 2px 6px rgba(33,150,243,.05)}
    .dropdown-selected i{font-size:14px;color:#1565c0;transition:transform .3s}
    .custom-dropdown.active .dropdown-selected i{transform:rotate(180deg)}
    .dropdown-list{position:absolute;top:100%;left:0;right:0;background:#fff;border:2px solid var(--blue-50);border-radius:10px;margin-top:6px;box-shadow:0 6px 20px rgba(0,0,0,.08);display:none;flex-direction:column;z-index:999;max-height:280px;overflow:hidden}
    .custom-dropdown.active .dropdown-list{display:flex}
    .dropdown-list input{border:none;border-bottom:1px solid var(--blue-50);padding:8px 10px;outline:none;font-size:14px;color:#1565c0}
    .dropdown-list div{flex:1;overflow-y:auto}
    .dropdown-item{padding:10px 12px;transition:.2s;cursor:pointer;color:#2c3e50}
    .dropdown-item:hover{background:var(--blue-50);color:#0d47a1}

    /* Toast */
    .toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);padding:12px 25px;border-radius:10px;color:#fff;font-size:15px;opacity:0;transition:all .4s.ease;z-index:9999}
    .toast.show{opacity:1;bottom:50px}
    .toast.success{background:#4caf50}.toast.error{background:#e74c3c}.toast.info{background:#3498db}

    /* Toggle scope buttons (All / Incoming to HR / Outgoing from HR) */
    .scope-switch{display:flex;gap:8px;margin:8px 0 16px;flex-wrap:wrap}
    .toggle-btn{background:#fff;color:#1565c0;border:2px solid #bbdefb;padding:8px 16px;border-radius:10px;font-weight:700;cursor:pointer}
    .toggle-btn.active{background:linear-gradient(90deg,#2196f3,#1976d2);color:#fff;box-shadow:0 4px 12px rgba(33,150,243,.3)}

    @keyframes fadeIn{
      from{opacity:0;transform:translateY(4px)}
      to{opacity:1;transform:translateY(0)}
    }

    @media (max-width:640px){
      .modal .row{grid-template-columns:1fr}
      .request-card{aspect-ratio:auto}
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar">
    <div class="logo-box">
      <img src="{{ url_for('static', filename='7s.jpg') }}" alt="logo">
      <h1>Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©</h1>
    </div>
    <div class="user-info">
      <span id="userWelcome">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
      <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬</button>
    </div>
  </nav>

  <div class="container">
    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" onclick="openTab('tab-requests', this)"><i class="fas fa-list"></i> Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
      <button class="tab-btn" onclick="openTab('tab-export', this)"><i class="fas fa-file-excel"></i> ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
      <button class="tab-btn" onclick="openTab('tab-users', this)"><i class="fas fa-users"></i> Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>
    </div>

    <!-- === Requests Tab === -->
    <div id="tab-requests" class="tab active">
      <div class="section-title"><i class="fas fa-inbox"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>

      <!-- Scope toggle -->
      <div class="scope-switch">
        <button id="scopeAll" class="toggle-btn active" onclick="setScope('all', this)"><i class="fas fa-layer-group"></i> Ø§Ù„ÙƒÙ„</button>
        <button id="scopeIncoming" class="toggle-btn" onclick="setScope('incoming', this)"><i class="fas fa-download"></i> Ø§Ù„ÙˆØ§Ø±Ø¯Ø© Ù„Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©</button>
        <button id="scopeOutgoing" class="toggle-btn" onclick="setScope('outgoing', this)"><i class="fas fa-upload"></i> Ø§Ù„Ù…Ø±Ø³Ù„Ø© Ù…Ù† Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©</button>
      </div>

      <div class="filters">
        <!-- Department dropdown with search -->
        <div class="custom-dropdown" id="deptDropdown">
          <div class="dropdown-selected" onclick="toggleDeptDropdown()">
            <span id="deptSelectedText">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="dropdown-list" id="deptList">
            <input type="text" id="deptSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù‚Ø³Ù…..." onkeyup="filterDeptList()"/>
            <div id="deptOptions"></div>
          </div>
        </div>

        <select id="statusFilter" class="form-control" onchange="renderRequests()">
          <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
          <option>Ø¬Ø¯ÙŠØ¯</option>
          <option>Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
          <option>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
          <option>Ù…Ø¹Ù„Ù‚</option>
          <option>Ù…ØºÙ„Ù‚</option>
          <option>Ù…Ø±ÙÙˆØ¶</option>
        </select>

        <input id="textSearch" class="form-control" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†/Ø§Ù„ÙˆØµÙ/Ø§Ù„Ø£Ø³Ù…Ø§Ø¡" oninput="renderRequests()" style="min-width:260px">

        <button class="btn btn-outline" onclick="loadRequests()"><i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ«</button>
        <button class="btn btn-primary" onclick="openNewRequestModal()"><i class="fas fa-plus"></i> Ø±ÙØ¹ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</button>
      </div>

      <div class="requests-grid" id="requestsContainer"><div class="no-requests">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>
    </div>

    <!-- === Export Tab === -->
    <div id="tab-export" class="tab">
      <div class="section-title"><i class="fas fa-file-export"></i> ØªØµØ¯ÙŠØ± Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
      <div class="filters">
        <select id="exportDept" class="form-control"></select>
        <input type="date" id="startDate" class="form-control">
        <input type="date" id="endDate" class="form-control">
        <button class="btn btn-green" onclick="exportRequests()"><i class="fas fa-file-excel"></i> ØªØµØ¯ÙŠØ±</button>
      </div>
      <p style="color:#607d8b">ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Excel Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ (ÙˆØ±Ù‚Ø© Ù„ÙƒÙ„ Ø­Ø§Ù„Ø©) ÙˆÙÙ‚ <b>Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</b> Ù„Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø­Ø¯Ø¯.</p>
    </div>

    <!-- === Users Tab (HR only) === -->
    <div id="tab-users" class="tab">
      <div class="section-title"><i class="fas fa-database"></i> Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>

      <div class="filters">
        <input id="searchBox" class="form-control" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„/Ø§Ù„Ù‚Ø³Ù…/Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©" oninput="renderUsers()">
        <select id="statusUserFilter" class="form-control" onchange="renderUsers()">
          <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
          <option value="Ù†Ø´Ø·">Ù†Ø´Ø·</option>
          <option value="Ù…Ø¤Ø±Ø´Ù">Ù…Ø¤Ø±Ø´Ù</option>
        </select>
        <button class="btn btn-primary" onclick="openUserModal()"><i class="fas fa-user-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</button>
      </div>

      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Ø§Ù„Ø§Ø³Ù…</th>
              <th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th>
              <th>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</th>
              <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
              <th>Ø§Ù„Ù‚Ø³Ù…</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th style="min-width:240px">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="usersBody">
            <tr><td colspan="7" class="no-requests">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal: Add/Edit User -->
  <div class="modal" id="userModal">
    <div class="modal-content">
      <h3 id="userModalTitle">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</h3>
      <div class="row">
        <div class="col">
          <label>Ø§Ù„Ø§Ø³Ù…</label>
          <input id="u_name" class="form-control">
        </div>
        <div class="col">
          <label>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</label>
          <input id="u_role" class="form-control" placeholder="Ù…ÙˆØ¸Ù / Ù…Ø¯ÙŠØ± Ù‚Ø³Ù… / Ù…Ø¯ÙŠØ± Ø¹Ø§Ù… / Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©">
        </div>
        <div class="col">
          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
          <input id="u_password" class="form-control">
        </div>
        <div class="col">
          <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
          <input id="u_email" class="form-control" placeholder="example@sevens.sa">
        </div>
        <div class="col">
          <label>Ø§Ù„Ù‚Ø³Ù…</label>
          <!-- ØªÙ… ØªØ­ÙˆÙŠÙ„Ù‡ Ø¥Ù„Ù‰ select Ù„ÙŠØªØ¹Ø¨Ù‘Ù‰ Ù…Ù† Ø§Ù„Ø£Ù‚Ø³Ø§Ù… -->
          <select id="u_department" class="form-control">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</option>
          </select>
        </div>
        <div class="col">
          <label>Ø§Ù„Ø­Ø§Ù„Ø©</label>
          <select id="u_status" class="form-control">
            <option>Ù†Ø´Ø·</option>
            <option>Ù…Ø¤Ø±Ø´Ù</option>
          </select>
        </div>
        <div class="col">
          <label>Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø£Ø®Ø±Ù‰ (Ø§ÙØµÙ„ Ø¨ÙŠÙ†Ù‡Ø§ Ø¨Ø§Ù„ÙØ§ØµÙ„Ø© ØŒ)</label>
          <input id="u_extra" class="form-control" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©ØŒ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª">
        </div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button class="btn btn-outline" onclick="closeUserModal()">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn btn-primary" id="userSaveBtn" onclick="saveUser()">Ø­ÙØ¸</button>
      </div>
    </div>
  </div>

  <!-- New Request Modal -->
  <div class="request-modal" id="newRequestModal">
    <div class="request-modal-content">
      <h3>Ø±ÙØ¹ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
      <form id="newRequestForm">
        <div class="form-group">
          <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø·Ù„Ø¨</label>
          <input id="requestTitle" type="text" required />
        </div>
        <div class="form-group">
          <label>ÙˆØµÙ Ø§Ù„Ø·Ù„Ø¨</label>
          <textarea id="requestDesc" rows="4" required></textarea>
        </div>
        <div class="form-group">
          <label>Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…</label>
          <select id="targetDept" required>
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</option>
          </select>
        </div>
        <div class="form-group">
          <label>Ø¥Ø±ÙØ§Ù‚ Ù…Ù„Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input type="file" id="requestFile" accept=".pdf,.jpg,.png,.docx,.xlsx" />
        </div>
        <button type="submit" class="submit-btn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
      </form>
    </div>
  </div>

  <!-- Ticket Details + Chat -->
  <div id="ticketDetailsModal" class="file-viewer-modal" onclick="closeTicketDetails(event)">
    <div class="file-viewer-content">
      <span class="close-btn" onclick="closeTicketDetails(event)">&times;</span>
      <div class="file-viewer-body">
        <h3 id="ticketTitle" style="margin-bottom:8px;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h3>
        <div id="ticketInfo" style="line-height:1.9;color:#334155"></div>

        <div id="chatSection" style="margin-top:20px;">
          <h4 style="color:#1565c0;margin-bottom:10px;"><i class="fas fa-comments"></i> Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h4>
          <div id="chatMessages" style="max-height:420px;overflow-y:auto;background:linear-gradient(180deg,#f8fbff,#e3f2fd);border-radius:14px;padding:14px;border:1px solid #bbdefb;box-shadow:inset 0 0 10px rgba(0,0,0,.05);">
            <div class="loading" style="text-align:center;color:#78909c;">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...</div>
          </div>
          <div id="chatInputArea" style="margin-top:12px;display:flex;flex-direction:column;gap:10px;">
            <div style="display:flex;gap:8px;align-items:center;">
              <textarea id="chatInput" placeholder="âœï¸ Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸ØªÙƒ Ø£Ùˆ Ø±Ø³Ø§Ù„ØªÙƒ..." style="flex:1;border-radius:12px;border:2px solid var(--blue-50);padding:10px;font-size:15px;height:70px;"></textarea>
              <input type="file" id="chatAttachment" accept=".pdf,.jpg,.png,.docx,.xlsx" style="display:none;">
              <button onclick="document.getElementById('chatAttachment').click()" class="btn btn-outline" title="Ø¥Ø±ÙØ§Ù‚"><i class="fas fa-paperclip"></i></button>
              <button onclick="sendChatMessage()" class="btn btn-primary">Ø¥Ø±Ø³Ø§Ù„</button>
            </div>
            <small id="selectedFileLabel" style="color:#1565c0;font-weight:600;"></small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Generic File Viewer -->
  <div id="fileViewerModal" class="file-viewer-modal" onclick="closeFileViewer(event)">
    <div class="file-viewer-content">
      <span class="close-btn" onclick="closeFileViewer(event)">&times;</span>
      <div id="fileViewerBody" class="file-viewer-body"></div>
    </div>
  </div>

  <script>
    /* ========== Utilities ========== */
    function normalizeArabicJS(t){
      t = (t||'').toString().trim();
      t = t.replace(/[\u200f\u200e]/g,'');
      t = t.replace(/[Ø¥Ø£Ø¢Ø§]/g,'Ø§');
      t = t.replace(/\s+/g,'');
      t = t.replace(/Ø©/g,'Ù‡');
      t = t.replace(/Ø§Ø¯Ø§Ø±Ø©|Ø¥Ø¯Ø§Ø±Ø©|Ø£Ø¯Ø§Ø±Ø©|Ø¢Ø¯Ø§Ø±Ø©|Ø§Ø¯Ø§Ø±Ù‡|Ø§Ù„Ø§Ø¯Ø§Ø±Ø©|Ø§Ù„Ø§Ø¯Ø§Ø±Ù‡/g,'Ø§Ø¯Ø§Ø±Ù‡');
      return t;
    }

    function showToast(msg, type="info"){
      const t=document.createElement('div');
      t.className=`toast show ${type}`;
      t.textContent=msg;
      document.body.appendChild(t);
      setTimeout(()=>t.remove(),3500);
    }

    function statusClass(s){
      if(!s) return 'status-in-progress';
      if(s.includes('Ø¬Ø¯ÙŠØ¯')) return 'status-new';
      if(s.includes('Ù…ØºÙ„Ù‚')) return 'status-closed';
      if(s.includes('Ø¬Ø§Ø±ÙŠ')) return 'status-in-progress';
      if(s.includes('Ù…Ø±ÙÙˆØ¶')) return 'status-rejected';
      return 'status-in-progress';
    }

    /* ========== State ========== */
    const HR_DEPT_NAME = normalizeArabicJS('Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©');


    let currentUser=null;
    let allRequests=[];
    let allUsers=[];
    let editingEmail=null;
    let hrEmployees=[]; // Ù…ÙˆØ¸ÙÙˆ HR Ù„Ù„ØªÙˆÙƒÙŠÙ„
    let scopeMode='all'; // all | incoming | outgoing

    /* ========== Tabs ========== */
    function openTab(id, btn){
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
    }

    /* ========== Page Bootstrapping ========== */
    window.onload = async ()=>{
      const saved=localStorage.getItem('sevens_user');
      if(!saved){
        location.href='Login.html';
        return;
      }
      currentUser=JSON.parse(saved);
      document.getElementById('userWelcome').textContent=`Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${currentUser.name} (${currentUser.department})`;

      // Ø§Ù„Ø³Ù…Ø§Ø­ ÙÙ‚Ø· Ù„Ù…Ù† Ø¯ÙˆØ±Ù‡ Ù…ÙˆØ§Ø±Ø¯ Ø¨Ø´Ø±ÙŠØ©
      const roleNorm = normalizeArabicJS(currentUser.role || '');
      const deptNorm = normalizeArabicJS(currentUser.department || '');

      const isHR =
            roleNorm.includes('Ù…ÙˆØ§Ø±Ø¯')
         || roleNorm.includes('Ø¨Ø´Ø±')
         || roleNorm.includes('Ø§Ø¯Ø§Ø±Ù‡Ø§Ù„Ù…ÙˆØ§Ø±Ø¯Ø§Ù„Ø¨Ø´Ø±ÙŠÙ‡')
         || deptNorm.includes('Ù…ÙˆØ§Ø±Ø¯')
         || deptNorm.includes('Ø¨Ø´Ø±')
         || deptNorm.includes('Ø§Ø¯Ø§Ø±Ù‡Ø§Ù„Ù…ÙˆØ§Ø±Ø¯Ø§Ù„Ø¨Ø´Ø±ÙŠÙ‡');

      if(!isHR){
        alert('Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù…Ø®ØµØµØ© Ù„Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ© ÙÙ‚Ø·.');
        location.href='Login.html';
        return;
      }

      // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
      await fillDepartmentsUI();

      // Ø¬Ù„Ø¨ Ù…ÙˆØ¸ÙÙŠ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ© Ù„Ù„ØªÙˆÙƒÙŠÙ„
      await loadHREmployees();

      // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª
      currentUser.role = "hr";
      await Promise.all([loadRequests(), loadUsers()]);

      // ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø·Ù„Ø¨Ø§Øª ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
      setInterval(async ()=>{
        try{
          const mf=document.getElementById('fileViewerModal');
          const nf=document.getElementById('newRequestModal');
          const tm=document.getElementById('ticketDetailsModal');
          const busy=(mf && mf.style.display==='flex')||(nf && nf.style.display==='flex')||(tm && tm.style.display==='flex');
          if(busy) return;

          const res=await fetch('/api/get_requests',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({
  role: "hr",
  name: currentUser.name,
  departments: [HR_DEPT_NAME]
})


          });
          const data=await res.json();
          const newData=Array.isArray(data)?data:[];
          if(JSON.stringify(newData)!==JSON.stringify(allRequests)){
            allRequests=newData;
            renderRequests();
          }
        }catch(e){
          console.warn('Auto refresh error',e);
        }
      },30000);

      // ØªØ­Ø¯ÙŠØ« Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„ØªØ°ÙƒØ±Ø© Ø§Ù„Ù…ÙØªÙˆØ­Ø© ÙƒÙ„ 10 Ø«ÙˆØ§Ù†Ù
      setInterval(()=>{
        const tm=document.getElementById('ticketDetailsModal');
        if(tm && tm.style.display==='flex'){
          const reqid=tm.dataset.reqid;
          if(reqid) loadChatMessages(reqid);
        }
      },10000);
    };

    async function fillDepartmentsUI(){
      try {
        const res = await fetch("/api/get_departments");
        const data = await res.json();
        const departments = data.departments || [];

        /** Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© ÙÙŠ Ø§Ù„ÙÙ„Ø§ØªØ± */
        const cont = document.getElementById("deptOptions");
        cont.innerHTML = "";

        // Ø®ÙŠØ§Ø± "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…"
        const allDiv = document.createElement("div");
        allDiv.className = "dropdown-item all-depts";
        allDiv.textContent = "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…";
        allDiv.onclick = () => selectDept("Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…");
        cont.appendChild(allDiv);

        departments.forEach(dep => {
          const d = document.createElement("div");
          d.className = "dropdown-item";
          d.textContent = dep;
          d.onclick = () => selectDept(dep);
          cont.appendChild(d);
        });

        /** Ù‚Ø³Ù… Ø§Ù„ØªØµØ¯ÙŠØ± */
        const exp = document.getElementById("exportDept");
        exp.innerHTML = "";
        departments.forEach(dep => {
          const o = document.createElement("option");
          o.value = dep;
          o.textContent = dep;
          exp.appendChild(o);
        });

        /** Ø±ÙØ¹ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ */
        const trg = document.getElementById("targetDept");
        trg.innerHTML = "";
        const ph = document.createElement("option");
        ph.value = "";
        ph.textContent = "Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…";
        trg.appendChild(ph);

        departments.forEach(dep => {
          const o = document.createElement("option");
          o.value = dep;
          o.textContent = dep;
          trg.appendChild(o);
        });

        /** Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… (Ø§Ù„Ù‚Ø³Ù…) */
        const userDept = document.getElementById("u_department");
        if (userDept) {
          userDept.innerHTML = "";
          const ph2 = document.createElement("option");
          ph2.value = "";
          ph2.textContent = "Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…";
          userDept.appendChild(ph2);

          departments.forEach(dep => {
            const o = document.createElement("option");
            o.value = dep;
            o.textContent = dep;
            userDept.appendChild(o);
          });
        }

      } catch (err) {
        console.error("Error loading departments:", err);
      }
    }

    async function loadHREmployees(){
      try{
        const res=await fetch('/api/get_employees',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({manager_name: currentUser.name, department: HR_DEPT_NAME})
        });
        const data=await res.json();
        if(data.success){
          hrEmployees=(data.employees||[]).filter(e=>
            normalizeArabicJS(e['Ø§Ù„Ù‚Ø³Ù…'])===normalizeArabicJS(HR_DEPT_NAME) &&
            (e['Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©']==='Ù…ÙˆØ¸Ù' || normalizeArabicJS(e['Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©']).includes('Ù…ÙˆØ¸Ù'))
          );
        }
      }catch(e){
        console.warn('loadHREmployees error',e);
      }
    }

    /* ===== Scope toggle ===== */
    function setScope(mode, btn){
      scopeMode=mode;
      document.querySelectorAll('.scope-switch .toggle-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      renderRequests();
    }

    /* ========== Requests ========== */
    async function loadRequests(){
      const c=document.getElementById('requestsContainer');
      c.innerHTML='<div class="no-requests">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
      try{
        const res=await fetch('/api/get_requests',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
  role: "hr",
  name: currentUser.name,
  departments: [HR_DEPT_NAME]
})


        });
        const data=await res.json();
        allRequests = Array.isArray(data)? data: [];
        renderRequests();
      }catch(e){
        console.error('loadRequests error:',e);
        c.innerHTML='<div class="no-requests">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>';
      }
    }

    function renderRequests(){
      const c=document.getElementById('requestsContainer');
      const deptSel=document.getElementById('deptSelectedText').textContent.trim()||'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…';
      const statSel=document.getElementById('statusFilter').value||'';
      const q=(document.getElementById('textSearch').value||'').toLowerCase().trim();

      let list=allRequests.slice();

      // scope filter
      if(scopeMode==='incoming'){
        list=list.filter(r=> normalizeArabicJS(r['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…']||'')===normalizeArabicJS(HR_DEPT_NAME));
      }else if(scopeMode==='outgoing'){
        list=list.filter(r=> normalizeArabicJS(r['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„']||'')===normalizeArabicJS(HR_DEPT_NAME));
      }

      // department filter (receiver or sender)
if (deptSel !== 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…') {
    const d = normalizeArabicJS(deptSel);
    list = list.filter(r => {
        const rec = normalizeArabicJS(r['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…'] || '');
        const snd = normalizeArabicJS(r['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„'] || '');
        return rec.includes(d) || snd.includes(d);
    });
}



      // status filter
      if(statSel) list=list.filter(r=>(r['Ø§Ù„Ø­Ø§Ù„Ø©']||'').includes(statSel));

      // text search
      if(q){
        list=list.filter(r=>{
          return [r['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†'],r['Ø§Ù„ÙˆØµÙ'],r['Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„'],r['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…'],r['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„'],r['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…']]
            .map(x=>(x||'').toString().toLowerCase())
            .some(v=>v.includes(q));
        });
      }

      if(!list.length){
        c.innerHTML='<div class="no-requests">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª.</div>';
        return;
      }

      c.innerHTML = list.map(req=>{
        const status=(req['Ø§Ù„Ø­Ø§Ù„Ø©']||'').trim();
        const fileName=req['Ø§Ù„Ù…Ù„Ù']||'';
        const recvIsHR = normalizeArabicJS(req['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…'])===normalizeArabicJS(HR_DEPT_NAME);
        const sendIsHR = normalizeArabicJS(req['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„'])===normalizeArabicJS(HR_DEPT_NAME);
        const canUpdate = recvIsHR; // HR ÙŠØ­Ø¯Ù‘Ø« ÙÙ‚Ø· Ø§Ù„ÙˆØ§Ø±Ø¯Ø© Ù„Ù‡
        return `
          <div class="request-card" data-id="${req['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨']||''}">
            <div class="status-header ${statusClass(status)}"></div>
            <div class="card-content">
              <div style="display:flex;justify-content:space-between;color:#607d8b;font-size:13px">
                <div>#${req['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨']||''}</div>
                <div>${req['Ø§Ù„ØªØ§Ø±ÙŠØ®']||''}</div>
              </div>

              <div class="request-title">${req['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†']||''}</div>
              <div style="color:#607d8b;margin:6px 0;">${req['Ø§Ù„ÙˆØµÙ']||''}</div>

              <div class="request-meta">
                <div><i class="fas fa-user"></i> Ø§Ù„Ù…Ø±Ø³Ù„: ${req['Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„']||'-'} (${req['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„']||'-'})</div>
                <div><i class="fas fa-user-check"></i> Ø§Ù„Ù…Ø³ØªÙ„Ù…: ${req['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…']||'-'} (${req['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…']||'-'})</div>
              </div>

              <div style="margin:8px 0;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                <span class="status-badge ${statusClass(status)}">${status||'-'}</span>
                <span style="color:#78909c">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${req['Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« Ø¨ÙˆØ§Ø³Ø·Ø©']||'-'}</span>
              </div>

              <div style="margin:8px 0;">
                ${
                  fileName
                    ? `<button class="btn btn-outline" onclick="openFileViewer('/uploads/${fileName}')"><i class="fas fa-paperclip"></i> Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙÙ‚</button>`
                    : `<span style="color:#9e9e9e"><i class="fas fa-paperclip"></i> Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚</span>`
                }
              </div>

              <div class="update-section">
                ${
                  canUpdate
                    ? `
                      <select class="status-select" onchange="updateRequestStatus('${req['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨']}', this.value)">
                        <option value="">ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©</option>
                        <option value="Ø¬Ø¯ÙŠØ¯">Ø¬Ø¯ÙŠØ¯</option>
                        <option value="Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
                        <option value="Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
                        <option value="Ù…Ø¹Ù„Ù‚">Ù…Ø¹Ù„Ù‚</option>
                        <option value="Ù…ØºÙ„Ù‚">Ù…ØºÙ„Ù‚</option>
                      </select>
                    `
                    : `<select class="status-select" disabled><option>Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</option></select>`
                }
                <span id="timer-${req['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨']}" class="timer-text">${(req['Ø§Ù„ÙˆÙ‚Øª']||'')||'00:00:00'}</span>
              </div>

              ${
                (recvIsHR || sendIsHR)
                  ? `
                    <div class="delegate-section" style="margin-top:10px;">
                      <select class="form-control" onchange="delegateRequest('${req['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨']}', this.value)">
                        <option value="">ØªÙˆÙƒÙŠÙ„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©</option>
                        ${hrEmployees.map(e=>`<option value="${e['Ø§Ù„Ø§Ø³Ù…']}">${e['Ø§Ù„Ø§Ø³Ù…']}</option>`).join('')}
                      </select>
                    </div>`
                  : ''
              }

              <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn btn-outline" onclick="openTicketDetails('${req['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨']}')"><i class="fas fa-comments"></i> Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙˆØ§Ù„Ø¯Ø±Ø¯Ø´Ø©</button>
              </div>
            </div>
          </div>
        `;
      }).join('');

      // timers after render
      setTimeout(()=>{
        list.forEach(req=>{
          const status=(req['Ø§Ù„Ø­Ø§Ù„Ø©']||'').trim();
          const timeStr=(req['Ø§Ù„ÙˆÙ‚Øª']||'00:00:00').trim();
          const [h,m,s]=timeStr.split(':').map(Number);
          const base=((h||0)*3600)+((m||0)*60)+(s||0);
          if(status==='Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°') startTimer(req['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨'], base);
          else if(status==='Ù…Ø¹Ù„Ù‚') pauseTimer(req['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨']);
        });
      },200);
    }

    // Department dropdown handlers
    function toggleDeptDropdown(){
      document.getElementById('deptDropdown').classList.toggle('active');
    }

    function selectDept(name){
      document.getElementById('deptSelectedText').textContent = name || 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…';
      document.getElementById('deptDropdown').classList.remove('active');
      renderRequests();
    }

    function filterDeptList(){
      const input=(document.getElementById('deptSearch').value||'').toLowerCase();
      document.querySelectorAll('#deptOptions .dropdown-item').forEach(el=>{
        const keep = el.textContent.toLowerCase().includes(input) || el.classList.contains('all-depts');
        el.style.display = keep? 'block':'none';
      });
    }

    window.addEventListener('click', (e)=>{
      const dd=document.getElementById('deptDropdown');
      if(dd && !dd.contains(e.target)) dd.classList.remove('active');
    });

    // File viewer generic
    function openFileViewer(url){
      const body=document.getElementById('fileViewerBody');
      body.innerHTML='';
      const ext=url.split('.').pop().toLowerCase();
      if(['jpg','jpeg','png','gif','webp'].includes(ext))
        body.innerHTML=`<img src="${url}" style="max-width:100%;border-radius:10px;">`;
      else if(ext==='pdf')
        body.innerHTML=`<iframe src="${url}" width="100%" height="520" style="border:none;border-radius:10px;"></iframe>`;
      else if(['xlsx','xls','docx','doc'].includes(ext))
        body.innerHTML=`<iframe src="https://view.officeapps.live.com/op/embed.aspx?src=${window.location.origin + url}" width="100%" height="520" frameborder="0"></iframe>`;
      else
        body.innerHTML=`<p>Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹ Ù…Ø¨Ø§Ø´Ø±Ø©. <a href="${url}" target="_blank">ØªØ­Ù…ÙŠÙ„</a></p>`;
      document.getElementById('fileViewerModal').style.display='flex';
    }

    function closeFileViewer(e){
      const modal=document.getElementById('fileViewerModal');
      if(e.target===modal || e.target.classList.contains('close-btn')){
        modal.style.display='none';
        document.getElementById('fileViewerBody').innerHTML='';
      }
    }

    // Timers
    const timers={};
    const savedTimes={};

    function startTimer(id, base=0){
      const el=document.getElementById(`timer-${id}`);
      if(!el) return;
      let seconds = savedTimes[id] ?? base ?? 0;
      clearInterval(timers[id]);
      timers[id]=setInterval(()=>{
        seconds++;
        savedTimes[id]=seconds;
        const h=String(Math.floor(seconds/3600)).padStart(2,'0');
        const m=String(Math.floor((seconds%3600)/60)).padStart(2,'0');
        const s=String(seconds%60).padStart(2,'0');
        el.textContent=`${h}:${m}:${s}`;
        if(seconds<300) el.style.background='#e8f5e9';
        else if(seconds<1800) el.style.background='#fff8e1';
        else el.style.background='#ffebee';
      },1000);
    }

    function pauseTimer(id){
      if(timers[id]){
        clearInterval(timers[id]);
        timers[id]=null;
      }
    }

    function stopTimer(id){
      if(timers[id]){
        clearInterval(timers[id]);
        delete timers[id];
      }
      const el=document.getElementById(`timer-${id}`);
      const t= el? el.textContent : '00:00:00';
      delete savedTimes[id];
      return t;
    }

    // Update status
    async function updateRequestStatus(reqId, newStatus){
      if(!newStatus) return;
      const payload={ requestId:reqId, status:newStatus, updater: currentUser.name };
      if(newStatus==='Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°') startTimer(reqId);
      if(newStatus==='Ù…Ø¹Ù„Ù‚') pauseTimer(reqId);
      if(newStatus==='Ù…ØºÙ„Ù‚') payload.duration = stopTimer(reqId);
      try{
        const res=await fetch('/api/update_request_status',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(payload)
        });
        const data=await res.json();
        if(data.success){
          showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© âœ…','success');
          await loadRequests();
        } else {
          showToast('ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ« âŒ','error');
        }
      }catch(e){
        console.error(e);
        showToast('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…','error');
      }
    }

    // Delegate
    async function delegateRequest(reqId, delegateName){
      if(!delegateName) return;
      if(!confirm(`ØªÙˆÙƒÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ ${reqId} Ø¥Ù„Ù‰ ${delegateName}ØŸ`)) return;
      try{
        const res=await fetch('/api/delegate_request',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({requestId:reqId, delegate:delegateName, delegatedBy: currentUser.name})
        });
        const data=await res.json();
        if(data.success){
          showToast(`ØªÙ… Ø§Ù„ØªÙˆÙƒÙŠÙ„ Ø¥Ù„Ù‰ ${delegateName} âœ…`,'success');
          loadRequests();
        } else {
          showToast('ÙØ´Ù„ ÙÙŠ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªÙˆÙƒÙŠÙ„ âŒ','error');
        }
      }catch(e){
        console.error(e);
        showToast('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…','error');
      }
    }

    // New Request Modal
    function openNewRequestModal(){
      const modal=document.getElementById('newRequestModal');
      modal.style.display='flex';
    }

    function closeNewRequestModal(){
      const modal=document.getElementById('newRequestModal');
      modal.style.display='none';
    }

    document.getElementById('newRequestForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const title=document.getElementById('requestTitle').value.trim();
      const desc=document.getElementById('requestDesc').value.trim();
      const target=document.getElementById('targetDept').value.trim();
      const fileInput=document.getElementById('requestFile');
      if(!title||!desc||!target){
        alert('ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„');
        return;
      }
      const fd=new FormData();
      fd.append('title',title);
      fd.append('description',desc);
      fd.append('targetDept',target);
      fd.append('senderDept', HR_DEPT_NAME);
      fd.append('senderName', currentUser.name);
      if(fileInput.files.length>0) fd.append('file', fileInput.files[0]);
      try{
        const res=await fetch('/api/create_request',{method:'POST', body:fd});
        const data=await res.json();
        if(data.success){
          showToast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ âœ…','success');
          closeNewRequestModal();
          e.target.reset();
          loadRequests();
        } else {
          alert('ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ' + (data.message||'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
        }
      }catch(err){
        console.error(err);
        alert('ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…');
      }
    });

    // Export
    async function exportRequests(){
      const dept=document.getElementById('exportDept').value||'';
      if(!dept){
        alert('Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ù„Ù„ØªØµØ¯ÙŠØ±');
        return;
      }
      const start=document.getElementById('startDate').value||null;
      const end=document.getElementById('endDate').value||null;
      const res=await fetch('/api/export_requests',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({department:dept,start_date:start,end_date:end})
      });
      const data=await res.json();
      if(data.success && data.file){
        window.location.href=`/download/${data.file}`;
      } else {
        alert(data.message || 'âŒ ÙØ´Ù„ Ø§Ù„ØªØµØ¯ÙŠØ±');
      }
    }

    // Ticket details + chat
    async function openTicketDetails(reqId){
      try{
        const ticket = allRequests.find(r=> (r['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨']||'')===reqId);
        if(!ticket){
          alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨');
          return;
        }
        document.getElementById('ticketTitle').textContent=`ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ #${reqId}`;
        document.getElementById('ticketInfo').innerHTML=`
          <p><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${ticket['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†']||''}</p>
          <p><strong>Ø§Ù„ÙˆØµÙ:</strong> ${ticket['Ø§Ù„ÙˆØµÙ']||''}</p>
          <p><strong>Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„:</strong> ${ticket['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„']||''}</p>
          <p><strong>Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…:</strong> ${ticket['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…']||''}</p>
          <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${ticket['Ø§Ù„Ø­Ø§Ù„Ø©']||''}</p>
        `;
        await loadChatMessages(reqId);
        const modal=document.getElementById('ticketDetailsModal');
        modal.style.display='flex';
        modal.dataset.reqid=reqId;

        const chatArea = document.getElementById('chatInputArea');
        const recvDept = normalizeArabicJS(ticket['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…'] || '');
        const sendDept = normalizeArabicJS(ticket['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„'] || '');
        const hrNorm   = normalizeArabicJS(HR_DEPT_NAME);

        // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¥Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ù…ÙˆØ¬Ù‡ Ù„Ù„Ù€HR Ø£Ùˆ ØµØ§Ø¯Ø± Ù…Ù†Ù‡Ø§
        chatArea.style.display = (recvDept === hrNorm || sendDept === hrNorm) ? 'flex' : 'none';

      }catch(e){
        console.error(e);
        alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„');
      }
    }

    function closeTicketDetails(e){
      const modal=document.getElementById('ticketDetailsModal');
      if(e.target===modal || e.target.classList.contains('close-btn')){
        modal.style.display='none';
        document.getElementById('chatMessages').innerHTML='';
      }
    }

    async function loadChatMessages(reqId){
      try{
        const res=await fetch(`/api/chat_get/${reqId}`);
        const msgs=await res.json();
        const box=document.getElementById('chatMessages');
        if(!Array.isArray(msgs)){
          box.innerHTML='<div style="text-align:center;color:#999">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„.</div>';
          return;
        }
        if(!msgs.length){
          box.innerHTML='<div style="text-align:center;color:#999">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¹Ø¯.</div>';
          return;
        }

        box.innerHTML = msgs.map(m=>{
          const sender  = m.sender  || m['Ø§Ù„Ù…Ø±Ø³Ù„']  || 'Ù…Ø¬Ù‡ÙˆÙ„';
          const message = m.message || m['Ø§Ù„Ø±Ø³Ø§Ù„Ø©'] || '';
          const file    = m.file    || m['Ø§Ù„Ù…Ù„Ù']   || '';
          const time    = m.time    || m['Ø§Ù„ÙˆÙ‚Øª']   || '';

          const mine = normalizeArabicJS(sender||'')===normalizeArabicJS(currentUser.name||'');
          const attach = file
            ? `<div class="chat-attachment"><a href="/chat_uploads/${file}" target="_blank"><i class="fas fa-paperclip"></i> ${file}</a></div>`
            : '';
          return `
            <div class="chat-msg ${mine?'me':'other'}">
              <div class="chat-meta">
                <span>${sender}</span>
                <span>${time}</span>
              </div>
              <div>${message}</div>
              ${attach}
            </div>
          `;
        }).join('');

        box.scrollTop = box.scrollHeight;
      }catch(e){
        console.error(e);
        document.getElementById('chatMessages').innerHTML='<div style="text-align:center;color:#999">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„.</div>';
      }
    }

    async function sendChatMessage(){
      const reqId = document.getElementById('ticketDetailsModal').dataset.reqid;
      const text = document.getElementById('chatInput').value.trim();
      const fileInput = document.getElementById('chatAttachment');
      if(!text && !fileInput.files.length){
        showToast('Ø£Ø¯Ø®Ù„ Ø±Ø³Ø§Ù„Ø© Ø£Ùˆ Ø£Ø±ÙÙ‚ Ù…Ù„ÙÙ‹Ø§','info');
        return;
      }

      const fd = new FormData();
      fd.append('request_id', reqId);
      fd.append('sender', currentUser.name);
      fd.append('department', currentUser.department || '');
      if(text) fd.append('message', text);
      if(fileInput.files.length>0) fd.append('file', fileInput.files[0]);

      try{
        const res = await fetch('/api/chat_send_file', { method:'POST', body:fd });
        const data = await res.json();
        if(data.success){
          document.getElementById('chatInput').value='';
          document.getElementById('chatAttachment').value='';
          document.getElementById('selectedFileLabel').textContent='';
          await loadChatMessages(reqId);
          showToast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© âœ…','success');
        }else{
          showToast('ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ âŒ','error');
        }
      }catch(e){
        console.error(e);
        showToast('ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…','error');
      }
    }

    document.getElementById('chatAttachment').addEventListener('change',(e)=>{
      const f = e.target.files[0];
      if(f) document.getElementById('selectedFileLabel').textContent = `ğŸ“ ${f.name}`;
      else document.getElementById('selectedFileLabel').textContent='';
    });

    /* ===== Users Management ===== */
    async function loadUsers(){
      try{
        const res = await fetch('/api/hr/list_users');
        const data = await res.json();
        allUsers = Array.isArray(data)?data:[];
        renderUsers();
      }catch(e){
        console.error('loadUsers error', e);
      }
    }

    function renderUsers(){
      const body=document.getElementById('usersBody');
      const q=(document.getElementById('searchBox').value||'').toLowerCase().trim();
      const statusFilter=document.getElementById('statusUserFilter').value||'';
      let list=allUsers.slice();

      if(statusFilter) list=list.filter(u=>(u['Ø§Ù„Ø­Ø§Ù„Ø©']||'').includes(statusFilter));
      if(q){
        list=list.filter(u=>{
          return [u['Ø§Ù„Ø§Ø³Ù…'],u['Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ'],u['Ø§Ù„Ù‚Ø³Ù…'],u['Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©']]
            .map(x=>(x||'').toString().toLowerCase())
            .some(v=>v.includes(q));
        });
      }

      if(!list.length){
        body.innerHTML='<tr><td colspan="7" class="no-requests">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©</td></tr>';
        return;
      }

      body.innerHTML=list.map(u=>`
        <tr>
          <td>${u['Ø§Ù„Ø§Ø³Ù…']||''}</td>
          <td>${u['Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©']||''}</td>
          <td>${u['ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±']||''}</td>
          <td>${u['Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ']||''}</td>
          <td>${u['Ø§Ù„Ù‚Ø³Ù…']||''}</td>
          <td>${u['Ø§Ù„Ø­Ø§Ù„Ø©']||''}</td>
          <td class="action-btns">
            <button class="btn btn-outline" onclick="editUser('${u['Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ']}')"><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„</button>
            ${
              u['Ø§Ù„Ø­Ø§Ù„Ø©']==='Ù†Ø´Ø·'
                ? `<button class="btn btn-danger" onclick="archiveUser('${u['Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ']}')"><i class="fas fa-box-archive"></i> Ø£Ø±Ø´ÙØ©</button>`
                : `<button class="btn btn-green" onclick="unarchiveUser('${u['Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ']}')"><i class="fas fa-undo"></i> Ø§Ø³ØªØ¹Ø§Ø¯Ø©</button>`
            }
          </td>
        </tr>
      `).join('');
    }

    function openUserModal(){
      editingEmail=null;
      document.getElementById('userModalTitle').textContent='Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…';
      clearUserModal();
      document.getElementById('userModal').style.display='flex';
    }

    function closeUserModal(){
      document.getElementById('userModal').style.display='none';
    }

    function clearUserModal(){
      ['u_name','u_role','u_password','u_email'].forEach(id=>document.getElementById(id).value='');
      document.getElementById('u_department').value='';
      document.getElementById('u_status').value='Ù†Ø´Ø·';
      document.getElementById('u_extra').value='';
    }

    function editUser(email){
      const u=allUsers.find(x=>x['Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ']===email);
      if(!u) return;
      editingEmail=email;
      document.getElementById('userModalTitle').textContent='ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù…';
      document.getElementById('u_name').value=u['Ø§Ù„Ø§Ø³Ù…']||'';
      document.getElementById('u_role').value=u['Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©']||'';
      document.getElementById('u_password').value=u['ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±']||'';
      document.getElementById('u_email').value=u['Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ']||'';
      document.getElementById('u_department').value=u['Ø§Ù„Ù‚Ø³Ù…']||'';
      document.getElementById('u_status').value=u['Ø§Ù„Ø­Ø§Ù„Ø©']||'Ù†Ø´Ø·';
      document.getElementById('u_extra').value = u['Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø£Ø®Ø±Ù‰'] || '';
      document.getElementById('userModal').style.display='flex';
    }

    async function saveUser(){
      const name=document.getElementById('u_name').value.trim();
      const role=document.getElementById('u_role').value.trim();
      const pass=document.getElementById('u_password').value.trim();
      const email=document.getElementById('u_email').value.trim();
      const dept=document.getElementById('u_department').value.trim();
      const status=document.getElementById('u_status').value.trim();
      const extra=document.getElementById('u_extra').value.trim();

      if(!name||!role||!pass||!email||!dept){
        showToast('ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„','error');
        return;
      }

      const payload = {
        name,
        role,
        password: pass,
        email,
        department: dept,
        status,
        extra_departments: extra
      };

      const url=editingEmail?'/api/hr/update_user':'/api/hr/add_user';
      try{
        const res=await fetch(url,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(payload)
        });
        const data=await res.json();
        if(data.success){
          showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ âœ…','success');
          closeUserModal();
          loadUsers();
        } else {
          showToast('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ âŒ','error');
        }
      }catch(e){
        console.error(e);
        showToast('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…','error');
      }
    }

    async function archiveUser(email){
      if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø£Ø±Ø´ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ')) return;
      const res=await fetch('/api/hr/archive_user',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({email,status:'Ù…Ø¤Ø±Ø´Ù'})
      });
      const data=await res.json();
      if(data.success){
        showToast('ØªÙ… Ø§Ù„Ø£Ø±Ø´ÙØ© âœ…','success');
        loadUsers();
      } else {
        showToast('ÙØ´Ù„ Ø§Ù„Ø£Ø±Ø´ÙØ© âŒ','error');
      }
    }

    async function unarchiveUser(email){
      if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ')) return;
      const res = await fetch('/api/hr/archive_user', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({email,status:'Ù†Ø´Ø·'})
      });
      const data=await res.json();
      if(data.success){
        showToast('ØªÙ… Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© âœ…','success');
        loadUsers();
      } else {
        showToast('ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© âŒ','error');
      }
    }

    /* ===== Logout ===== */
    function logout(){
      if(confirm('ØªØ£ÙƒÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')){
        localStorage.removeItem('sevens_user');
        location.href='Login.html';
      }
    }

    /* ===== Session check ===== */
    async function sessionCheck() {
      try {
        const res = await fetch("/api/auth/session_check");
        const data = await res.json();

        if (!data.valid) {
          localStorage.removeItem("sevens_user");
          window.location.href = "/Login.html";
          return;
        }

        localStorage.setItem("sevens_user", JSON.stringify(data.user));
      } catch (e) {
        console.error("Session error:", e);
        localStorage.removeItem("sevens_user");
        window.location.href = "/Login.html";
      }
    }

    // ÙØ­Øµ Ø§Ù„Ø¬Ù„Ø³Ø© Ø£ÙˆÙ„ Ù…Ø§ ØªÙØªØ­ Ø§Ù„ØµÙØ­Ø©
    sessionCheck();
    // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙØ­Øµ ÙƒÙ„ 20 Ø«Ø§Ù†ÙŠØ©
    setInterval(sessionCheck, 20000);
  </script>
</body>
</html>
