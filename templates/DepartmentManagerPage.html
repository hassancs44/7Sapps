<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù„ÙˆØ­Ø© Ù…Ø¯ÙŠØ± Ø§Ù„Ù‚Ø³Ù… | SEVENS</title>

  <!-- Ø§Ù„Ø®Ø·ÙˆØ· ÙˆØ§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    /* =========================================================
    ğŸ¨ ØªØµÙ…ÙŠÙ… Ù„ÙˆØ­Ø© SEVENS â€“ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ù†Ø¸Ù…Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
    ========================================================= */

    /* ğŸ¨ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Tajawal', sans-serif;
    }

    body {
      background: #f8fbff;
      color: #2c3e50;
      min-height: 100vh;
    }

    /* ===== Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ (Navbar) ===== */
    .navbar {
      background: white;
      padding: 18px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo-box {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .logo-box img {
      width: 44px;
      height: 44px;
      object-fit: contain;
      border-radius: 10px;
    }

    .logo-box h1 {
      color: #1e88e5;
      font-size: 22px;
      font-weight: 700;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      color: #34495e;
      font-weight: 600;
    }

    .logout-btn {
      background: #e3f2fd;
      color: #1976d2;
      border: none;
      padding: 6px 14px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
    }
    .logout-btn:hover {
      background: #bbdefb;
    }

    /* ===== Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø© ===== */
    .container {
      max-width: 1100px;
      margin: 30px auto;
      padding: 0 20px;
    }

    /* ===== Ø±Ø¤ÙˆØ³ Ø§Ù„ØµÙØ­Ø§Øª ===== */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .page-title {
      font-size: 26px;
      color: #0d47a1;
      font-weight: 700;
    }

    .section-title {
      font-size: 22px;
      color: #1e88e5;
      margin: 30px 0 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e3f2fd;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* ===== Ø²Ø± Ø±ÙØ¹ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ ===== */
    .new-request-btn {
      padding: 10px 20px;
      background: linear-gradient(to right, #2196f3, #1976d2);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .new-request-btn:hover {
      box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
    }

    /* ===== Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª ===== */
    .requests-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 22px;
      justify-content: center;
    }

    .request-card {
  background: #ffffff;
  border-radius: 18px;
  border: 1px solid #dce9f7;
  padding: 0;
  overflow: hidden;
  box-shadow: 0 4px 8px rgba(0,0,0,0.05);
  transition: 0.25s ease;
  cursor: pointer;
  display: flex;
  flex-direction: column;
}

.request-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 10px 22px rgba(30, 136, 229, 0.18);
}


    .status-header {
  height: 5px;
  width: 100%;
}

    .status-new { background: #2196f3; }
    .status-in-progress { background: #ff9800; }
    .status-closed { background: #4caf50; }
    .status-rejected { background: #f44336; }

    .card-content {
      padding: 10px 0 0;
      height: 100%;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .card-top {
  display: flex;
  justify-content: space-between;
  padding: 12px 16px;
  background: #f5f9ff;
  font-size: 13px;
  color: #607d8b;
  border-bottom: 1px solid #e3f2fd;
}


    .request-title {
  font-size: 18px;
  font-weight: 700;
  color: #0d47a1;
  padding: 10px 16px 0;
  line-height: 1.4;
}


    .request-desc {
  font-size: 14px;
  color: #546e7a;
  padding: 0 16px;
  margin-bottom: 10px;
  line-height: 1.5;
}


    .request-meta.meta-box {
  background: #f0f6ff;
  padding: 12px 16px;
  border-radius: 14px;
  margin: 0 16px 10px;
  border: 1px solid #d0e3ff;
}


.meta-row {
  display: flex;
  align-items: center;
  gap: 8px;
  color: #37474f;
  font-size: 13px;
  margin-bottom: 4px;
}

.meta-row i {
  color: #64b5f6;
}

    .request-meta .meta-item i {
      margin-left: 4px;
      color: #90caf9;
    }

    .status-info {
  background: #f8fbff;
  padding: 12px 16px;
  border-radius: 12px;
  margin: 0 16px 10px;
  border: 1px solid #e3f2fd;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 13px;
}


    .status-label {
      color: #607d8b;
      margin-left: 4px;
    }

    .status-badge {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 12px;
      color: #fff;
    }

    .status-badge.status-new { background: #2196f3; }
    .status-badge.status-in-progress { background: #ff9800; }
    .status-badge.status-closed { background: #4caf50; }
    .status-badge.status-rejected { background: #f44336; }

    .view-file-btn {
  margin: 0 16px 10px;
  padding: 8px 14px;
  background: #1e88e5;
  border-radius: 10px;
  color: white;
  font-size: 13px;
  border: none;
  cursor: pointer;
  transition: 0.2s;
}
.view-file-btn:hover {
  background: #1565c0;
}


    .no-requests {
      text-align: center;
      padding: 30px;
      color: #7f8c8d;
      font-style: italic;
      grid-column: 1/-1;
    }

    /* ===== Ø§Ù„ØªØµØ¯ÙŠØ± ===== */
    .export-section {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .export-btn {
      background: #43a047;
      color: white;
      padding: 10px 18px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
    }
    .export-btn:hover {
      background: #388e3c;
    }

    /* ===== ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© ===== */
    #statusFilter {
      border: 2px solid #e3f2fd;
      border-radius: 10px;
      padding: 10px;
      background: white;
      color: #0d47a1;
      font-weight: 600;
    }
    #statusFilter:focus {
      outline: none;
      border-color: #1e88e5;
      box-shadow: 0 0 8px rgba(30, 136, 229, 0.3);
    }

    /* âœ³ï¸ ØªÙˆÙ‡Ø¬ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙ†ÙÙŠØ° */
    .card-glow {
      border: 2px solid #81c784 !important;
      box-shadow: 0 0 18px rgba(129, 199, 132, 0.6) !important;
      transition: all .3s ease-in-out;
    }

    /* ğŸ¤– Ø§Ù„Ø´Ø§Øª Ø¨ÙˆØª Ø§Ù„Ø¹Ø§Ø¦Ù… */
    .chatbot-float-btn {
      position: fixed;
      bottom: 25px;
      left: 25px;
      background: linear-gradient(135deg, #42a5f5, #1e88e5);
      color: white;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 26px;
      cursor: pointer;
      box-shadow: 0 6px 20px rgba(30, 136, 229, 0.3);
      z-index: 1000;
    }

    .chatbot-widget {
      position: fixed;
      bottom: 100px;
      left: 25px;
      width: 350px;
      max-height: 520px;
      background: #fff;
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 6px 25px rgba(0, 0, 0, 0.15);
      display: none;
      flex-direction: column;
      z-index: 1000;
    }
    .chatbot-widget.show {
      display: flex;
    }
    .chatbot-widget.hidden {
      display: none !important;
    }

    .cb-header {
      background: linear-gradient(135deg, #2196f3, #1565c0);
      color: white;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .cb-body {
      flex: 1;
      overflow-y: auto;
      padding: 14px;
      background: #f8fbff;
    }

    .cb-msg {
      margin-bottom: 12px;
      padding: 10px 14px;
      border-radius: 12px;
      max-width: 80%;
      line-height: 1.6;
      font-size: 14px;
    }
    .cb-msg.user {
      background: #e3f2fd;
      color: #0d47a1;
      margin-left: auto;
    }
    .cb-msg.bot {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .cb-input {
      display: flex;
      border-top: 1px solid #e3f2fd;
    }
    .cb-input textarea {
      flex: 1;
      border: none;
      padding: 10px;
      font-family: 'Tajawal';
      font-size: 14px;
      resize: none;
    }
    .cb-send {
      background: #1e88e5;
      color: white;
      border: none;
      padding: 0 16px;
      cursor: pointer;
    }

    /* âœ… Ù†Ù…ÙˆØ°Ø¬ Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø¨ (Ù…Ù†Ø¨Ø«Ù‚ ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ) */
    .request-modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.45);
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    .request-modal-content {
      background: #fff;
      width: 90%;
      max-width: 500px;
      border-radius: 18px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      position: relative;
      text-align: right;
    }

    .form-group { margin-bottom: 20px; }

    .form-control {
      width: 100%;
      padding: 12px;
      border: 2px solid #e3f2fd;
      border-radius: 12px;
      font-size: 15px;
      direction: rtl;
    }

    .submit-btn {
      width: 100%;
      padding: 12px;
      background: linear-gradient(to right, #2196f3, #1976d2);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
    }
    .submit-btn:hover {
      background: linear-gradient(to right, #1e88e5, #1565c0);
    }

    /* ğŸ—‚ï¸ Ù†Ø§ÙØ°Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª */
    .file-viewer-modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.6);
      justify-content: center;
      align-items: center;
      z-index: 3000;
      padding: 20px;
    }

    .file-viewer-content {
      background: white;
      border-radius: 16px;
      padding: 20px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow: auto;
      position: relative;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .file-viewer-body { text-align: center; }

    .close-btn {
      position: absolute;
      top: 10px;
      left: 15px;
      font-size: 26px;
      cursor: pointer;
      color: #444;
      transition: .2s;
    }
    .close-btn:hover {
      color: #e53935;
    }

    /* âœ… Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± ØºÙŠØ± Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù†Ù‚Ø± */
    .file-viewer-modal:not([style*="display: flex"]) {
      pointer-events: none !important;
      opacity: 0;
    }
    .file-viewer-modal[style*="display: flex"] {
      pointer-events: auto;
      opacity: 1;
    }

    /* ===== Ø¶Ø¨Ø· Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø³ÙÙ„ÙŠ (Ø§Ù„ÙˆÙ‚Øª + Ø§Ù„Ø­Ø§Ù„Ø©) ===== */
    .update-section {
  background: #f4f9ff;
  padding: 12px 16px;
  border-top: 1px solid #e3f2fd;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-radius: 0 0 16px 16px;
}


    .status-select {
      padding: 8px 10px;
      border: 2px solid #e3f2fd;
      border-radius: 8px;
      font-weight: 600;
      color: #1e88e5;
      background-color: white;
      cursor: pointer;
      transition: 0.2s;
    }
    .status-select:hover {
      border-color: #90caf9;
    }

    .timer-text {
  background: #ffffff;
  border: 1px solid #c8e6c9;
  padding: 6px 10px;
  border-radius: 8px;
  min-width: 70px;
  text-align: center;
  font-weight: 600;
  color: #2e7d32;
}


    /* ğŸ©µ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù„Ù„Ø£Ù‚Ø³Ø§Ù… */
    .custom-dropdown {
      position: relative;
      width: 220px;
      font-family: 'Tajawal';
    }

    .dropdown-selected {
      background: white;
      border: 2px solid #e3f2fd;
      border-radius: 10px;
      padding: 10px 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #0d47a1;
      cursor: pointer;
      transition: 0.25s;
      box-shadow: 0 2px 6px rgba(33, 150, 243, 0.05);
    }
    .dropdown-selected:hover {
      box-shadow: 0 4px 10px rgba(33, 150, 243, 0.15);
    }
    .dropdown-selected i {
      font-size: 14px;
      color: #1565c0;
      transition: transform 0.3s ease;
    }
    .custom-dropdown.active .dropdown-selected i {
      transform: rotate(180deg);
    }

    .dropdown-list {
      position: absolute;
      top: 100%;
      right: 0;
      left: 0;
      background: white;
      border: 2px solid #e3f2fd;
      border-radius: 10px;
      margin-top: 6px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
      display: none;
      flex-direction: column;
      z-index: 999;
      max-height: 250px;
      overflow: hidden;
    }
    .custom-dropdown.active .dropdown-list {
      display: flex;
    }

    .dropdown-list input {
      border: none;
      border-bottom: 1px solid #e3f2fd;
      padding: 8px 10px;
      outline: none;
      font-size: 14px;
      color: #1565c0;
    }

    .dropdown-list div { flex: 1; overflow-y: auto; }

    .dropdown-item {
      padding: 10px 12px;
      transition: 0.2s;
      cursor: pointer;
      color: #2c3e50;
    }
    .dropdown-item:hover {
      background: #e3f2fd;
      color: #0d47a1;
    }

    /* ğŸ’¬ Ø±Ø³Ø§Ø¦Ù„ Ø´Ø§Øª Ø§Ù„ØªØ°ÙƒØ±Ø© */
    .chat-msg {
      margin-bottom: 12px;
      padding: 10px 14px;
      border-radius: 14px;
      max-width: 75%;
      word-wrap: break-word;
      position: relative;
      font-size: 14px;
      line-height: 1.6;
      animation: fadeIn 0.4s ease;
    }
    .chat-msg.me {
      margin-left: auto;
      background: #e3f2fd;
      color: #0d47a1;
      border-top-right-radius: 0;
      box-shadow: 0 3px 6px rgba(33,150,243,0.2);
    }
    .chat-msg.other {
      margin-right: auto;
      background: #e8f5e9;
      color: #1b5e20;
      border-top-left-radius: 0;
      box-shadow: 0 3px 6px rgba(76,175,80,0.2);
    }
    .chat-meta {
      font-size: 12px;
      color: #607d8b;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
    }
    .chat-attachment a {
      color: #1565c0;
      font-weight: 600;
      text-decoration: none;
    }
    .chat-attachment a:hover {
      text-decoration: underline;
    }

    @keyframes fadeIn {
      from {opacity:0;transform:translateY(5px);}
      to {opacity:1;transform:translateY(0);}
    }

    /* ğŸ”˜ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ÙˆØ§Ø±Ø¯ ÙˆØ§Ù„Ù…Ø±Ø³Ù„ */
    .toggle-btn {
      background: white;
      color: #1565c0;
      border: 2px solid #bbdefb;
      padding: 10px 22px;
      margin: 0 6px;
      border-radius: 10px;
      font-weight: 600;
      font-family: 'Tajawal', sans-serif;
      cursor: pointer;
      transition: 0.3s;
    }
    .toggle-btn:hover {
      background: #e3f2fd;
    }
    .toggle-btn.active {
      background: linear-gradient(to right, #2196f3, #1976d2);
      color: white;
      box-shadow: 0 4px 12px rgba(33,150,243,0.3);
    }

    /* Ø´Ø§Ø±Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© */
    .chat-badge {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 20px;
      height: 20px;
      background: #f44336;
      color: white;
      border-radius: 50%;
      font-size: 12px;
      font-weight: bold;
      display: none;
      justify-content: center;
      align-items: center;
      box-shadow: 0 0 8px rgba(244,67,54,0.6);
    }

    @keyframes blinkAnim {
      0%,100% { box-shadow: 0 0 10px rgba(33,150,243,0.2); }
      50%     { box-shadow: 0 0 25px rgba(33,150,243,0.8); }
    }
    .blink {
      animation: blinkAnim 1.5s ease-in-out;
    }

    /* Toast Ø¨Ø³ÙŠØ· */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #333;
      color: #fff;
      padding: 10px 18px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 5000;
      opacity: 0.95;
    }
    .toast.success { background: #43a047; }
    .toast.error { background: #e53935; }
    .toast.info { background: #1e88e5; }
  </style>
</head>

<body>
  <!-- ğŸ”¹ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
  <nav class="navbar">
    <div class="logo-box">
      <img src="{{ url_for('static', filename='7s.jpg') }}" alt="Ø´Ø¹Ø§Ø± SEVENS">
      <h1>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h1>
    </div>
    <div class="user-info">
      <span id="userWelcome">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
      <button class="logout-btn" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬
      </button>
    </div>
  </nav>

  <!-- ğŸ”˜ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
  <div style="text-align:center; margin:25px 0;">
    <button id="btnIncoming" class="toggle-btn active">
      <i class="fas fa-inbox"></i> Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©
    </button>
    <button id="btnOutgoing" class="toggle-btn">
      <i class="fas fa-paper-plane"></i> Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø©
    </button>
  </div>

  <!-- ğŸ”¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
  <div class="container">
    <div class="page-header">
      <h2 class="page-title" id="pageTitle">Ù„ÙˆØ­Ø© Ù…Ø¯ÙŠØ± Ø§Ù„Ù‚Ø³Ù…</h2>

      <div class="export-section">
        <select id="statusFilter" onchange="filterRequests()">
          <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
          <option value="Ø¬Ø¯ÙŠØ¯">Ø¬Ø¯ÙŠØ¯</option>
          <option value="Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
          <option value="Ù…ØºÙ„Ù‚">Ù…ØºÙ„Ù‚</option>
          <option value="Ù…Ø±ÙÙˆØ¶">Ù…Ø±ÙÙˆØ¶</option>
        </select>

        <div class="custom-dropdown" id="deptDropdown">
          <div class="dropdown-selected" onclick="toggleDeptDropdown()">
            <span id="deptSelectedText">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø§Øª</span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="dropdown-list" id="deptList">
            <input type="text" id="deptSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù‚Ø³Ù…..." onkeyup="filterDeptList()"/>
            <div id="deptOptions"></div>
          </div>
        </div>

        <button class="export-btn" style="background:#1e88e5" onclick="loadRequests()">
          <i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ«
        </button>

        <input type="date" id="startDate">
        <input type="date" id="endDate">
        <button class="export-btn" onclick="exportRequests()">
          <i class="fas fa-file-excel"></i> ØªØµØ¯ÙŠØ± Ø§Ù„Ø·Ù„Ø¨Ø§Øª
        </button>
        <button class="new-request-btn" onclick="openNewRequestModal()">
          <i class="fas fa-plus"></i> Ø±ÙØ¹ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
        </button>
      </div>
    </div>

    <h3 class="section-title"><i class="fas fa-download"></i> Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h3>
    <div class="requests-grid" id="incoming-requests">
      <div class="no-requests">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </div>

    <h3 class="section-title"><i class="fas fa-upload"></i> Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø©</h3>
    <div class="requests-grid" id="outgoing-requests">
      <div class="no-requests">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </div>
  </div>

  <!-- ğŸ”¹ Ù†Ù…ÙˆØ°Ø¬ Ø±ÙØ¹ Ø·Ù„Ø¨ -->
  <div class="request-modal" id="newRequestModal">
    <div class="request-modal-content">
      <h3>Ø±ÙØ¹ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
      <form id="newRequestForm">
        <div class="form-group">
          <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø·Ù„Ø¨</label>
          <input id="requestTitle" class="form-control" required />
        </div>
        <div class="form-group">
          <label>ÙˆØµÙ Ø§Ù„Ø·Ù„Ø¨</label>
          <textarea id="requestDesc" class="form-control" rows="4" required></textarea>
        </div>
        <!-- Ø§Ø®ØªÙŠØ§Ø± Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„ (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ Ø¹Ù†Ø¯Ù‡ Ø£ÙƒØ«Ø± Ù…Ù† Ù‚Ø³Ù…) -->
<div class="form-group" id="senderDeptWrapper" style="display:none;">
  <label>Ø¥Ø±Ø³Ø§Ù„ Ù…Ù† Ù‚Ø³Ù…</label>
  <select id="senderDeptSelect" class="form-control"></select>
</div>

<!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø© -->
<div class="form-group">
  <label>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©</label>
  <select id="targetDept" class="form-control" required>
    <option value="">Ø§Ø®ØªØ± Ø¥Ø¯Ø§Ø±Ø©</option>
  </select>
</div>


        <div class="form-group">
          <label>Ø¥Ø±ÙØ§Ù‚ Ù…Ù„Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input type="file" id="requestFile" class="form-control" accept=".pdf,.jpg,.png,.docx,.xlsx"/>
        </div>
        <button type="submit" class="submit-btn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
      </form>
    </div>
  </div>

  <!-- ğŸ¤– Ø²Ø± Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø¹Ø§Ù… -->
  <div class="chatbot-float-btn" onclick="toggleChat()"><i class="fas fa-robot"></i></div>

  <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø¹Ø§Ù… -->
  <div id="chatbotWidget" class="chatbot-widget hidden" aria-live="polite">
    <div class="cb-header">
      <div class="cb-title"><i class="fas fa-robot"></i> Ù…Ø³Ø§Ø¹Ø¯ SEVENS</div>
      <button class="cb-close" onclick="toggleChat(false)" title="Ø¥ØºÙ„Ø§Ù‚">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div id="cbBody" class="cb-body"></div>

    <div class="cb-input">
      <textarea id="cbInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ... (Enter Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ØŒ Shift+Enter Ù„Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯)"></textarea>
      <button id="cbSend" class="cb-send" onclick="sendChat()">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
  </div>

  <!-- ğŸ—¨ï¸ Ù†Ø§ÙØ°Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ§Ù„Ø¯Ø±Ø¯Ø´Ø© -->
  <div id="ticketDetailsModal" class="file-viewer-modal" onclick="closeTicketDetails(event)">
    <div class="file-viewer-content" style="max-width:900px;">
      <span class="close-btn" onclick="closeTicketDetails(event)">&times;</span>
      <div id="ticketDetailsBody" class="file-viewer-body">
        <h3 id="ticketTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h3>
        <div id="ticketInfo"></div>

        <!-- ğŸ’¬ Ù‚Ø³Ù… Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª -->
        <div id="chatSection" style="margin-top:25px;">
          <h4 style="color:#1565c0;margin-bottom:12px;">
            <i class="fas fa-comments"></i> Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
          </h4>

          <div id="chatMessages" style="
              max-height:400px;
              overflow-y:auto;
              background:linear-gradient(180deg,#f8fbff,#e3f2fd);
              border-radius:14px;
              padding:14px;
              border:1px solid #bbdefb;
              box-shadow:inset 0 0 10px rgba(0,0,0,0.05);
            ">
            <div class="loading" style="text-align:center;color:#78909c;">
              Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...
            </div>
          </div>

          <div id="chatInputArea" style="margin-top:14px;display:flex;flex-direction:column;gap:10px;">
            <div style="display:flex;gap:8px;align-items:center;">
              <textarea id="chatInput" placeholder="âœï¸ Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸ØªÙƒ Ø£Ùˆ Ø±Ø³Ø§Ù„ØªÙƒ..." style="flex:1;border-radius:12px;border:2px solid #e3f2fd;padding:10px;font-size:15px;height:70px;"></textarea>
              <input type="file" id="chatAttachment" accept=".pdf,.jpg,.png,.docx,.xlsx" style="display:none;">
              <button onclick="document.getElementById('chatAttachment').click()" class="view-file-btn" style="height:45px;">
                <i class="fas fa-paperclip"></i>
              </button>
              <button onclick="sendChatMessage()" class="submit-btn" style="height:45px;width:auto;padding:0 18px;">
                Ø¥Ø±Ø³Ø§Ù„
              </button>
            </div>
            <small id="selectedFileLabel" style="color:#1565c0;font-weight:600;"></small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ğŸ—‚ï¸ Ù†Ø§ÙØ°Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª -->
  <div id="fileViewerModal" class="file-viewer-modal" onclick="closeFileViewer(event)">
    <div class="file-viewer-content">
      <span class="close-btn" onclick="closeFileViewer(event)">&times;</span>
      <div id="fileViewerBody" class="file-viewer-body"></div>
    </div>
  </div>

  <!-- ğŸ”¹ Ø§Ù„Ø³ÙƒØ±Ø¨Øª -->
  <script>
    // ==================== Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© ====================
    let currentUser = null;
    let allEmployees = [];
    let timers = {};
    let savedTimes = {};
    let lastChatCount = {};
    let lastRequestsCache = [];

    // ==================== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ù†Øµ Ø§Ù„Ø¹Ø±Ø¨ÙŠ ====================
    function normalizeArabicJS(t) {
      t = (t || '').toString().trim();
      t = t.replace(/[Ø¥Ø£Ø¢Ø§]/g, 'Ø§');
      t = t.replace(/\s+/g, '');
      t = t.replace(/Ø©/g, 'Ù‡');
      t = t.replace(/\u200f|\u200e/g, '');
      t = t.replace(/^Ø§Ø¯Ø§Ø±Ù‡?/g, 'Ø§Ø¯Ø§Ø±Ù‡');
      return t;
    }

    function normalizeDept(name) {
      if (!name) return "";
      return normalizeArabicJS(name).replace(/[^Ø§-ÙŠ]/g, '').trim();
    }

    // ==================== Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ====================
    function mapUserRole(user) {
      let role = (user.role || '').toString().toLowerCase().trim();

      const valid = ["admin","hr","general_manager","manager","employee"];
      if (valid.includes(role)) {
        return role;
      }

      const ar = (user.role || '').toString();
      const norm = normalizeArabicJS(ar);

      if (norm.includes("Ø¹Ø§Ù…")) return "general_manager";
      if (norm.includes("Ù‚Ø³Ù…") || norm.includes("Ù…Ø¯ÙŠØ±Ù‚Ø³Ù…") || norm.includes("Ù…Ø¯ÙŠØ±")) return "manager";
      if (norm.includes("Ù…ÙˆØ¸Ù")) return "employee";

      return "employee";
    }

    function buildAllDepartments(user) {
      user.allDepartments = [];

      if (user.department) {
        user.allDepartments.push(user.department.trim());
      }

      let extraList = [];

      if (Array.isArray(user.extra_departments)) {
        extraList = user.extra_departments;
      } else if (user.extraDepartments) {
        extraList = user.extraDepartments.split(',').map(x => x.trim()).filter(x => x);
      } else if (user.extra_depts) {
        extraList = user.extra_depts.split(',').map(x => x.trim()).filter(x => x);
      } else if (user["Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø£Ø®Ø±Ù‰"]) {
        extraList = user["Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø£Ø®Ø±Ù‰"].split(',').map(x => x.trim()).filter(x => x);
      }

      if (Array.isArray(extraList)) {
        extraList = extraList.map(d => d.trim()).filter(d => d !== "");
        user.allDepartments.push(...extraList);
      }

      // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±
      user.allDepartments = [...new Set(user.allDepartments)];

      return user;
    }

    function getStoredUser() {
      let raw = localStorage.getItem("currentUser") || localStorage.getItem("sevens_user");
      if (!raw) return null;
      try {
        return JSON.parse(raw);
      } catch (e) {
        return null;
      }
    }

    async function sessionCheck() {
      try {
        const res = await fetch("/api/auth/session_check");
        const data = await res.json();

        if (!data.valid) {
          localStorage.removeItem("currentUser");
          localStorage.removeItem("sevens_user");
          window.location.href = "/Login.html";
          return;
        }

        // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø©
        localStorage.setItem("currentUser", JSON.stringify(data.user));
        localStorage.setItem("sevens_user", JSON.stringify(data.user));
      } catch (e) {
        console.error("Session error:", e);
      }
    }

    async function initUserFromSession() {
      let user = getStoredUser();
      if (!user) {
        await sessionCheck();
        user = getStoredUser();
      }
      if (!user) {
        window.location.href = "Login.html";
        return null;
      }

      user.role = mapUserRole(user);
      user = buildAllDepartments(user);

      localStorage.setItem("currentUser", JSON.stringify(user));
      return user;
    }

    // ==================== ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø¹Ø§Ø¦Ù… ====================
    function appendMsg(sender, text) {
      const cbBody = document.getElementById("cbBody");
      if (!cbBody) return;
      const msgDiv = document.createElement("div");
      msgDiv.classList.add("cb-msg", sender === "user" ? "user" : "bot");
      msgDiv.textContent = text;
      cbBody.appendChild(msgDiv);
      cbBody.scrollTop = cbBody.scrollHeight;
    }

    function toggleChat(force) {
      const widget = document.getElementById("chatbotWidget");
      if (!widget) return;

      const isHidden = widget.classList.contains("hidden") || !widget.classList.contains("show");
      let open;

      if (force === true) open = true;
      else if (force === false) open = false;
      else open = isHidden;

      if (open) {
        widget.classList.remove("hidden");
        widget.classList.add("show");
      } else {
        widget.classList.remove("show");
        widget.classList.add("hidden");
      }
    }

    async function sendChat() {
      const input = document.getElementById("cbInput");
      const text = (input.value || "").trim();
      if (!text) return;

      appendMsg("user", text);
      input.value = "";

      try {
        const res = await fetch("/api/chatbot", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: text, user: currentUser ? currentUser.name : "unknown" })
        });

        const data = await res.json();
        const reply = data.reply || "ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø³Ø¤Ø§Ù„ÙƒØŒ Ø³ÙŠØªÙ… Ø§Ù„Ø±Ø¯ Ù…Ù† Ø®Ù„Ø§Ù„ Ø§Ù„Ù†Ø¸Ø§Ù….";
        appendMsg("bot", reply);
      } catch (e) {
        console.error(e);
        appendMsg("bot", "ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… Ø­Ø§Ù„ÙŠØ§Ù‹ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹.");
      }
    }

    // ==================== Toast Ø¨Ø³ÙŠØ· ====================
    function showToast(msg, type = "info") {
      const toast = document.createElement("div");
      toast.className = `toast ${type}`;
      toast.textContent = msg;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3500);
    }

    // ==================== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ====================
    async function loadEmployees() {
      try {
        const res = await fetch('/api/get_employees', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            manager_name: currentUser.name,
            department: currentUser.department
          })
        });

        const data = await res.json();
        if (data.success) {
          allEmployees = data.employees || [];
          console.log("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†:", allEmployees.length);
        } else {
          console.warn("âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†:", data.message);
        }
      } catch (err) {
        console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†:", err);
      }
    }

    // ==================== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± ====================
    function updateTargetDeptList(departments) {
      const select = document.getElementById("targetDept");
      if (!select) return;
      select.innerHTML = `<option value="">Ø§Ø®ØªØ± Ø¥Ø¯Ø§Ø±Ø©</option>`;
      departments.forEach(dep => {
        const opt = document.createElement("option");
        opt.value = dep;
        opt.textContent = dep;
        select.appendChild(opt);
      });
    }

    async function loadDepartments() {
      try {
        const res = await fetch("/api/get_departments");
        const data = await res.json();
        if (!data.departments) return;

        const departments = data.departments;
        const cont = document.getElementById("deptOptions");
        cont.innerHTML = "";

        // Ø®ÙŠØ§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø§Øª
        const allDiv = document.createElement("div");
        allDiv.className = "dropdown-item all-depts";
        allDiv.textContent = "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø§Øª";
        allDiv.onclick = () => selectDept("Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø§Øª");
        cont.appendChild(allDiv);

        departments.forEach(dep => {
          const d = document.createElement("div");
          d.className = "dropdown-item";
          d.textContent = dep;
          d.onclick = () => selectDept(dep);
          cont.appendChild(d);
        });

        updateTargetDeptList(departments);
      } catch (err) {
        console.error("âŒ Error loading departments:", err);
      }
    }

    function toggleDeptDropdown() {
      document.getElementById('deptDropdown').classList.toggle('active');
    }

    function selectDept(name) {
      document.getElementById('deptSelectedText').textContent = name || "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø§Øª";
      document.getElementById('deptDropdown').classList.remove('active');
      filterRequests();
    }

    function filterDeptList() {
      const input = document.getElementById("deptSearch").value.toLowerCase();
      const items = document.querySelectorAll(".dropdown-item");

      items.forEach(i => {
        if (i.classList.contains("all-depts")) {
          i.style.display = "block";
        } else {
          i.style.display = i.textContent.toLowerCase().includes(input) ? "block" : "none";
        }
      });
    }

    // ==================== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ====================
    async function loadRequestsForUser() {
      if (!currentUser) return;

      try {
        const res = await fetch('/api/get_requests', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            role: currentUser.role,
            departments: currentUser.allDepartments,
            name: currentUser.name
          })
        });

        const data = await res.json();
        if (!Array.isArray(data)) {
          console.error("ØµÙŠØºØ© ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹Ø© Ù…Ù† /api/get_requests", data);
          return;
        }

        lastRequestsCache = data;

        const departmentsNorm = currentUser.allDepartments.map(d => normalizeDept(d));
        const incoming = [];
        const outgoing = [];

        data.forEach(r => {
          const recv = normalizeDept(r['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…']);
          const send = normalizeDept(r['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„']);

          departmentsNorm.forEach(depNorm => {
            if (recv === depNorm) incoming.push(r);
            if (send === depNorm) outgoing.push(r);
          });
        });

        renderRequests("incoming-requests", incoming);
        renderRequests("outgoing-requests", outgoing);

        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ« (Ø­Ø§Ù„Ø© + Ù‚Ø³Ù…)
        filterRequests();
      } catch (e) {
        console.error('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª:', e);
        document.getElementById('incoming-requests').innerHTML =
          '<div class="no-requests">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>';
      }
    }

    function loadRequests() {
      loadRequestsForUser();
    }

    // ==================== Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø­Ø§Ù„Ø§Øª ====================
    function statusToClass(s) {
      s = s || "";
      if (s.includes('Ø¬Ø¯ÙŠØ¯')) return 'status-new';
      if (s.includes('Ù…ØºÙ„Ù‚')) return 'status-closed';
      if (s.includes('Ø¬Ø§Ø±ÙŠ')) return 'status-in-progress';
      if (s.includes('Ù…Ø±ÙÙˆØ¶')) return 'status-rejected';
      return 'status-new';
    }

    // ==================== Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ====================
    function renderRequests(containerId, list) {
      const c = document.getElementById(containerId);
      if (!Array.isArray(list) || !list.length) {
        c.innerHTML = '<div class="no-requests">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª.</div>';
        return;
      }

      c.innerHTML = list.map(req => {
        const status = (req['Ø§Ù„Ø­Ø§Ù„Ø©'] || '').trim();
        const fileName = req['Ø§Ù„Ù…Ù„Ù'] || '';
        const reqId = req['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨'] || '';

        const canUpdateStatus =
          currentUser.allDepartments
            .map(d => normalizeArabicJS(d))
            .includes(normalizeArabicJS(req['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…']));

        const isManager =
          currentUser.role === "manager" ||
          normalizeArabicJS(currentUser.role).includes("Ù…Ø¯ÙŠØ±");

        const delegateOptions = isManager
          ? allEmployees
              .filter(emp =>
                normalizeArabicJS(emp['Ø§Ù„Ù‚Ø³Ù…']) === normalizeArabicJS(currentUser.department) &&
                emp['Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©'] === 'Ù…ÙˆØ¸Ù'
              )
              .map(emp => `<option value="${emp['Ø§Ù„Ø§Ø³Ù…']}">${emp['Ø§Ù„Ø§Ø³Ù…']}</option>`)
              .join('')
          : '';

        return `
  <div class="request-card" data-id="${reqId}">
    <div class="status-header ${statusToClass(status)}"></div>

    <div class="card-content">

      <!-- ğŸ”µ Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© -->
      <div class="card-top">
        <span class="request-id">#${reqId}</span>
        <span class="request-date">${req['Ø§Ù„ØªØ§Ø±ÙŠØ®'] || ''}</span>
      </div>

      <!-- ğŸ”· Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„ÙˆØµÙ -->
      <h3 class="request-title">${req['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†'] || ''}</h3>
      <p class="request-desc">${req['Ø§Ù„ÙˆØµÙ'] || ''}</p>

      <!-- ğŸ”¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ø±Ø³Ù„ ÙˆÙ…Ø³ØªÙ„Ù… -->
      <div class="request-meta meta-box">
        <div class="meta-row">
          <i class="fas fa-user"></i>
          <span>Ø§Ù„Ù…Ø±Ø³Ù„: ${req['Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„'] || '-'} â€” (${req['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„'] || '-'})</span>
        </div>

        <div class="meta-row">
          <i class="fas fa-user-check"></i>
          <span>Ø§Ù„Ù…Ø³ØªÙ„Ù…: ${req['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…'] || '-'} â€” (${req['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…'] || '-'})</span>
        </div>
      </div>

      <!-- ğŸŸ© Ø§Ù„Ø­Ø§Ù„Ø© -->
      <div class="status-info">
        <div>
          <span class="status-label">Ø§Ù„Ø­Ø§Ù„Ø©:</span>
          <span class="status-badge ${statusToClass(status)}">${status}</span>
        </div>
        <div>
          <span class="status-label">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:</span>
          ${req['Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« Ø¨ÙˆØ§Ø³Ø·Ø©'] || '-'}
        </div>
      </div>

      <!-- ğŸŸ¡ Ø§Ù„Ù…Ù„Ù -->
      ${
        fileName
        ? `
          <button class="view-file-btn"
            onclick="event.stopPropagation(); openFileViewer('/uploads/${fileName}')">
            <i class="fas fa-paperclip"></i> Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙÙ‚
          </button>
        `
        : `<div class="meta-item" style="color:#789;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚</div>`
      }

      <!-- ğŸŸ£ Ø§Ù„ØªÙˆÙƒÙŠÙ„ ÙÙ‚Ø· Ù„Ù„ÙˆØ§Ø±Ø¯ -->
      ${
        (isManager && containerId === "incoming-requests")
          ? `
            <div class="delegate-box">
              <select class="form-control delegate-select"
                onclick="event.stopPropagation()"
                onchange="delegateRequest('${reqId}', this.value)">
                <option value="">ØªÙˆÙƒÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨â€¦</option>
                ${delegateOptions}
              </select>
            </div>
          `
          : ''
      }

      <!-- âš« Ø£Ø³ÙÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© (Ø§Ù„Ø­Ø§Ù„Ø© + Ø§Ù„ÙˆÙ‚Øª) -->
      <div class="update-section">
        ${
          canUpdateStatus
          ? `
            <select class="status-select"
              onclick="event.stopPropagation()"
              onchange="updateRequestStatus('${reqId}', this.value, event)">
              <option value="">ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©</option>
              <option value="Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
              <option value="Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
              <option value="Ù…Ø¹Ù„Ù‚">Ù…Ø¹Ù„Ù‚</option>
              <option value="Ù…ØºÙ„Ù‚">Ù…ØºÙ„Ù‚</option>
            </select>
          `
          : `<select class="status-select" disabled><option>Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</option></select>`
        }

        <span id="timer-${reqId}" class="timer-text">${req['Ø§Ù„ÙˆÙ‚Øª'] || '00:00:00'}</span>
      </div>

    </div>

    <!-- ğŸ”´ Ø´Ø§Ø±Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ -->
    <div class="chat-badge"></div>
  </div>
`;
      }).join('');

      // Ø±Ø¨Ø· ÙØªØ­ Ø§Ù„ØªÙØ§ØµÙŠÙ„
      c.querySelectorAll('.request-card').forEach(card => {
        card.addEventListener('click', () => {
          openTicketDetails(card.dataset.id);
        });
      });

      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø¤Ù‚ØªØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
      setTimeout(() => {
        list.forEach(req => {
          const status = (req['Ø§Ù„Ø­Ø§Ù„Ø©'] || '').trim();
          const timeStr = (req['Ø§Ù„ÙˆÙ‚Øª'] || '00:00:00').trim();
          const [h, m, s] = timeStr.split(':').map(Number);
          const totalSec = (h || 0) * 3600 + (m || 0) * 60 + (s || 0);

          if (status === 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°') startTimer(req['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨'], totalSec);
          else if (status === 'Ù…Ø¹Ù„Ù‚') pauseTimer(req['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨']);
        });
      }, 300);
    }

    // ==================== ÙÙ„ØªØ±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Ø­Ø§Ù„Ø© + Ù‚Ø³Ù…) ====================
    function filterRequests() {
      const status = document.getElementById("statusFilter").value.trim();
      const deptText = document.getElementById("deptSelectedText").textContent.trim();
      const allCards = document.querySelectorAll(".request-card");

      const normalizedDept = normalizeArabicJS(deptText);
      const isAllDepts = !deptText || deptText === "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø§Øª" || deptText === "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…";

      allCards.forEach(card => {
        const textRaw = card.innerText || "";
        const textNorm = normalizeArabicJS(textRaw);

        const badge = card.querySelector('.status-badge');
        const cardStatus = badge ? badge.textContent.trim() : '';
        const matchStatus = !status || normalizeArabicJS(cardStatus) === normalizeArabicJS(status);

        let matchDept = true;
        if (!isAllDepts) {
          matchDept =
            textNorm.includes(normalizedDept) ||
            textNorm.includes(deptText.replace(/\s/g, ""));
        }

        card.style.display = (matchStatus && matchDept) ? "block" : "none";
      });

      if (isAllDepts) {
        document.getElementById("pageTitle").textContent = "Ù„ÙˆØ­Ø© Ù…Ø¯ÙŠØ± Ø§Ù„Ù‚Ø³Ù…";
      } else {
        document.getElementById("pageTitle").textContent = `Ø·Ù„Ø¨Ø§Øª Ù‚Ø³Ù… ${deptText}`;
      }
    }

    // ==================== ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ====================
    async function updateRequestStatus(reqId, newStatus, ev) {
      if (ev) ev.stopPropagation();
      if (!newStatus) return;

      const updater = currentUser.name;
      const payload = { requestId: reqId, status: newStatus, updater };

      if (newStatus === "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°") {
        startTimer(reqId);
      }

      if (newStatus === "Ù…Ø¹Ù„Ù‚") {
        pauseTimer(reqId);
      }

      if (newStatus === "Ù…ØºÙ„Ù‚") {
        const duration = stopTimer(reqId);
        payload.duration = duration;
      }

      try {
        const res = await fetch('/api/update_request_status', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        if (data.success) {
          showToast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­ âœ…", "success");
          await loadRequestsForUser();
        } else {
          showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ« âŒ", "error");
        }
      } catch (e) {
        console.error(e);
        showToast("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…", "error");
      }
    }

    // ==================== Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¤Ù‚Øª ====================
    function startTimer(reqId, baseSeconds = null) {
      const el = document.getElementById(`timer-${reqId}`);
      if (!el) return;

      let seconds = savedTimes[reqId] ?? baseSeconds ?? 0;

      clearInterval(timers[reqId]);
      timers[reqId] = setInterval(() => {
        seconds++;
        savedTimes[reqId] = seconds;
        const h = String(Math.floor(seconds / 3600)).padStart(2, '0');
        const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
        const s = String(seconds % 60).padStart(2, '0');
        el.textContent = `${h}:${m}:${s}`;

        if (seconds < 300) el.style.background = '#e8f5e9';
        else if (seconds < 1800) el.style.background = '#fff8e1';
        else el.style.background = '#ffebee';
      }, 1000);
    }

    function pauseTimer(reqId) {
      if (timers[reqId]) {
        clearInterval(timers[reqId]);
        timers[reqId] = null;
      }
    }

    function stopTimer(reqId) {
      if (timers[reqId]) {
        clearInterval(timers[reqId]);
        delete timers[reqId];
      }
      const el = document.getElementById(`timer-${reqId}`);
      const time = el ? el.textContent : "00:00:00";
      delete savedTimes[reqId];
      return time;
    }

    // ==================== ØªØµØ¯ÙŠØ± Ø§Ù„Ø·Ù„Ø¨Ø§Øª ====================
    async function exportRequests() {
      const start = document.getElementById('startDate').value || null;
      const end = document.getElementById('endDate').value || null;

      // Ø­Ø§Ù„ÙŠÙ‹Ø§ Ù„Ù… Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ§Ø±ÙŠØ® Ø­ØªÙ‰ Ù„Ø§ Ù†ÙƒØ³Ø± Ø§Ù„Ù€ backend
      try {
        const res = await fetch('/api/export_requests', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            role: currentUser.role,
            departments: currentUser.allDepartments,
            name: currentUser.name
          })
        });

        const data = await res.json();
        if (data.success && data.file) {
          window.location.href = `/download/${data.file}`;
        } else {
          alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØµØ¯ÙŠØ± Ø§Ù„Ø·Ù„Ø¨Ø§Øª');
        }
      } catch (e) {
        console.error(e);
        alert('âŒ ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØµØ¯ÙŠØ±');
      }
    }

    // ==================== Ø§Ù„ØªÙˆÙƒÙŠÙ„ ====================
    async function delegateRequest(reqId, delegateName) {
      if (!delegateName) return;
      if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ ØªÙˆÙƒÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø±Ù‚Ù… ${reqId} Ø¥Ù„Ù‰ ${delegateName}ØŸ`)) return;

      try {
        const res = await fetch('/api/delegate_request', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            requestId: reqId,
            delegate: delegateName,
            delegatedBy: currentUser.name
          })
        });

        const data = await res.json();
        if (data.success) {
          showToast(`ØªÙ… ØªÙˆÙƒÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ ${delegateName} âœ…`, "success");
          await loadRequestsForUser();
        } else {
          showToast("âŒ ÙØ´Ù„ ÙÙŠ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªÙˆÙƒÙŠÙ„", "error");
        }
      } catch (e) {
        console.error('âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙˆÙƒÙŠÙ„:', e);
        showToast("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…", "error");
      }
    }

    // ==================== Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ====================
    function openFileViewer(url) {
      const viewerBody = document.getElementById('fileViewerBody');
      viewerBody.innerHTML = '';
      const ext = url.split('.').pop().toLowerCase();

      if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) {
        viewerBody.innerHTML = `<img src="${url}" style="max-width:100%;border-radius:10px;">`;
      } else if (ext === 'pdf') {
        viewerBody.innerHTML = `<iframe src="${url}" width="100%" height="500px" style="border:none;border-radius:10px;"></iframe>`;
      } else if (['xlsx', 'xls', 'docx', 'doc'].includes(ext)) {
        viewerBody.innerHTML = `<iframe src="https://view.officeapps.live.com/op/embed.aspx?src=${window.location.origin + url}" width="100%" height="500px" frameborder="0"></iframe>`;
      } else {
        viewerBody.innerHTML = `<p>Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹ Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ø¨Ø§Ø´Ø±Ø©. ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ù…ÙŠÙ„Ù‡ <a href="${url}" target="_blank">Ù…Ù† Ù‡Ù†Ø§</a>.</p>`;
      }

      document.getElementById('fileViewerModal').style.display = 'flex';
    }

    function closeFileViewer(e) {
      const modal = document.getElementById('fileViewerModal');
      if (e.target === modal || e.target.classList.contains('close-btn')) {
        modal.style.display = 'none';
        document.getElementById('fileViewerBody').innerHTML = '';
      }
    }

    // ==================== Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ====================
    function openNewRequestModal() {
      const modal = document.getElementById('newRequestModal');
      // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ø®ØªÙŠØ§Ø± Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„ Ø¥Ø°Ø§ Ø¹Ù†Ø¯Ù‡ Ø£ÙƒØ«Ø± Ù…Ù† Ù‚Ø³Ù…
const wrapper = document.getElementById("senderDeptWrapper");
const select = document.getElementById("senderDeptSelect");

if (currentUser.allDepartments && currentUser.allDepartments.length > 1) {
  wrapper.style.display = "block";
  select.innerHTML = currentUser.allDepartments
    .map(dep => `<option value="${dep}">${dep}</option>`)
    .join('');
} else {
  wrapper.style.display = "none";
}

      modal.style.display = 'flex';

      setTimeout(() => {
        document.addEventListener('click', handleOutsideClickForNewRequest);
      }, 200);
    }

    function closeNewRequestModal() {
      const modal = document.getElementById('newRequestModal');
      modal.style.display = 'none';
      document.removeEventListener('click', handleOutsideClickForNewRequest);
    }

    function handleOutsideClickForNewRequest(e) {
      const modal = document.getElementById('newRequestModal');
      const content = modal.querySelector('.request-modal-content');
      const openButton = document.querySelector('.new-request-btn');

      if (
        modal.style.display === 'flex' &&
        !content.contains(e.target) &&
        e.target !== openButton &&
        !openButton.contains(e.target)
      ) {
        closeNewRequestModal();
      }
    }

    async function handleNewRequestSubmit(e) {
      e.preventDefault();

      const title = document.getElementById('requestTitle').value.trim();
      const desc  = document.getElementById('requestDesc').value.trim();
      const targetDept = document.getElementById('targetDept').value.trim();
      const fileInput = document.getElementById('requestFile');

      if (!title || !desc || !targetDept) {
        alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„");
        return;
      }

      const formData = new FormData();
      formData.append('title', title);
      formData.append('description', desc);
      formData.append('targetDept', targetDept);
      // Ø§Ø®ØªÙŠØ§Ø± Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„: Ø¥Ø°Ø§ Ø¹Ù†Ø¯Ù‡ Ø¹Ø¯Ø© Ø£Ù‚Ø³Ø§Ù… ÙŠØ£Ø®Ø° Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
const senderDept =
  (currentUser.allDepartments.length > 1)
    ? document.getElementById('senderDeptSelect').value
    : currentUser.department;

formData.append('senderDept', senderDept);

      formData.append('senderName', currentUser.name);
      if (fileInput.files.length > 0) {
        formData.append('file', fileInput.files[0]);
      }

      try {
        const res = await fetch('/api/create_request', {
          method: 'POST',
          body: formData
        });
        const data = await res.json();

        if (data.success) {
          alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­");
          closeNewRequestModal();
          document.getElementById('newRequestForm').reset();
          await loadRequestsForUser();
        } else {
          alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: " + (data.message || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
        }
      } catch (e) {
        console.error('âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:', e);
        alert("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ¹Ù…Ù„.");
      }
    }

    // ==================== Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬ ====================
    function logout() {
      if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
        localStorage.removeItem('currentUser');
        localStorage.removeItem('sevens_user');
        alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­ âœ…');
        window.location.href = 'Login.html';
      }
    }

    // ==================== ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ§Ù„Ø¯Ø±Ø¯Ø´Ø© ====================
    async function openTicketDetails(reqId) {
      try {
        // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        lastChatCount[reqId] = 0;
        updateChatBadge(reqId, 0);

        let ticket = lastRequestsCache.find(r => r['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨'] === reqId);
        if (!ticket) {
          const res = await fetch('/api/get_requests', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({
              role: currentUser.role,
              departments: currentUser.allDepartments,
              name: currentUser.name
            })
          });
          const data = await res.json();
          ticket = data.find(r => r['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨'] === reqId);
        }

        if (!ticket) {
          alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨.');
          return;
        }

        document.getElementById('ticketTitle').textContent = `ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ #${reqId}`;
        document.getElementById('ticketInfo').innerHTML = `
          <p><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${ticket['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†'] || ''}</p>
          <p><strong>Ø§Ù„ÙˆØµÙ:</strong> ${ticket['Ø§Ù„ÙˆØµÙ'] || ''}</p>
          <p><strong>Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„:</strong> ${ticket['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„'] || ''}</p>
          <p><strong>Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…:</strong> ${ticket['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…'] || ''}</p>
          <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${ticket['Ø§Ù„Ø­Ø§Ù„Ø©'] || ''}</p>
        `;

        await loadChatMessages(reqId);

        const modal = document.getElementById('ticketDetailsModal');
        modal.style.display = 'flex';
        modal.dataset.reqid = reqId;
      } catch (e) {
        console.error(e);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„.');
      }
    }

    function closeTicketDetails(e) {
      const modal = document.getElementById('ticketDetailsModal');
      if (e.target === modal || e.target.classList.contains('close-btn')) {
        modal.style.display = 'none';
        document.getElementById('chatMessages').innerHTML = '';
      }
    }

    async function loadChatMessages(reqId) {
      try {
        const res = await fetch(`/api/chat_get/${reqId}`);
        const msgs = await res.json();
        const box = document.getElementById('chatMessages');

        if (!Array.isArray(msgs) || msgs.length === 0) {
          box.innerHTML = '<div style="text-align:center;color:#78909c;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¹Ø¯ ğŸ’¬</div>';
          return;
        }

        box.innerHTML = msgs.map(m => `
          <div class="chat-msg ${normalizeArabicJS(m['Ø§Ù„Ù‚Ø³Ù…']) === normalizeArabicJS(currentUser.department) ? 'me' : 'other'}">
            <div class="chat-meta">
              <strong>${m['Ø§Ù„Ù…Ø±Ø³Ù„']}</strong>
              <span class="chat-time">${m['Ø§Ù„ÙˆÙ‚Øª']}</span>
            </div>
            <div class="chat-text">${m['Ø§Ù„Ø±Ø³Ø§Ù„Ø©'] || ''}</div>
            ${m['Ø§Ù„Ù…Ù„Ù'] ? `
              <div class="chat-attachment">
                <a href="/chat_uploads/${m['Ø§Ù„Ù…Ù„Ù']}" target="_blank">
                  <i class="fas fa-paperclip"></i> ${m['Ø§Ù„Ù…Ù„Ù']}
                </a>
              </div>` : ''}
          </div>
        `).join('');

        if (!lastChatCount[reqId]) lastChatCount[reqId] = 0;
        if (msgs.length > lastChatCount[reqId]) {
          const newCount = msgs.length - lastChatCount[reqId];
          showToast(`ğŸ“© ÙˆØµÙ„ØªÙƒ ${newCount} Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©`, "info");
          updateChatBadge(reqId, newCount);
          blinkChatIcon();
        }
        lastChatCount[reqId] = msgs.length;

        box.scrollTop = box.scrollHeight;
      } catch (e) {
        console.error("loadChatMessages error:", e);
      }
    }

    async function sendChatMessage() {
      const modal = document.getElementById('ticketDetailsModal');
      const reqId = modal.dataset.reqid;
      const msg = document.getElementById('chatInput').value.trim();
      const fileInput = document.getElementById('chatAttachment');
      if (!msg && fileInput.files.length === 0) return;

      const formData = new FormData();
      formData.append('request_id', reqId);
      formData.append('sender', currentUser.name);
      formData.append('department', currentUser.department);
      formData.append('message', msg);

      if (fileInput.files.length > 0) {
        formData.append('file', fileInput.files[0]);
      }

      try {
        const res = await fetch('/api/chat_send_file', {
          method: 'POST',
          body: formData
        });

        const data = await res.json();
        if (data.success) {
          document.getElementById('chatInput').value = '';
          document.getElementById('chatAttachment').value = '';
          document.getElementById('selectedFileLabel').textContent = '';
          await loadChatMessages(reqId);
          updateChatBadge(reqId, 0);
        } else {
          alert('âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©');
        }
      } catch (e) {
        console.error(e);
      }
    }

    // ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªØ°ÙƒØ±Ø© Ø§Ù„Ù…ÙØªÙˆØ­Ø©
    async function refreshOpenTicketChat() {
      const modal = document.getElementById('ticketDetailsModal');
      if (modal && modal.style.display === 'flex') {
        const reqId = modal.dataset.reqid;
        await loadChatMessages(reqId);
      }
    }

    function updateChatBadge(reqId, count) {
      const card = document.querySelector(`.request-card[data-id='${reqId}']`);
      if (!card) return;

      let badge = card.querySelector('.chat-badge');
      if (!badge) {
        badge = document.createElement('div');
        badge.className = 'chat-badge';
        card.appendChild(badge);
      }

      if (count > 0) {
        badge.textContent = count > 9 ? '9+' : count;
        badge.style.display = 'flex';
      } else {
        badge.style.display = 'none';
      }
    }

    function blinkChatIcon() {
      const btn = document.querySelector('.chatbot-float-btn');
      if (!btn) return;
      btn.classList.add('blink');
      setTimeout(() => btn.classList.remove('blink'), 2000);
    }

    // ==================== Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ÙˆØ§Ø±Ø¯ ÙˆØ§Ù„Ù…Ø±Ø³Ù„ ====================
    function setupIncomingOutgoingToggle() {
      const btnIncoming = document.getElementById("btnIncoming");
      const btnOutgoing = document.getElementById("btnOutgoing");
      const incoming = document.getElementById("incoming-requests");
      const outgoing = document.getElementById("outgoing-requests");
      const incomingTitle = document.querySelector("h3.section-title:nth-of-type(1)");
      const outgoingTitle = document.querySelector("h3.section-title:nth-of-type(2)");

      function showIncoming() {
        incoming.style.display = "grid";
        outgoing.style.display = "none";
        incomingTitle.style.display = "block";
        outgoingTitle.style.display = "none";
        btnIncoming.classList.add("active");
        btnOutgoing.classList.remove("active");
      }

      function showOutgoing() {
        incoming.style.display = "none";
        outgoing.style.display = "grid";
        incomingTitle.style.display = "none";
        outgoingTitle.style.display = "block";
        btnIncoming.classList.remove("active");
        btnOutgoing.classList.add("active");
      }

      btnIncoming.addEventListener("click", showIncoming);
      btnOutgoing.addEventListener("click", showOutgoing);

      showIncoming();
    }

    // ==================== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø© ====================
    document.addEventListener("DOMContentLoaded", async () => {
      currentUser = await initUserFromSession();
      if (!currentUser) return;

      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‡ÙŠØ¯Ø±
      document.getElementById("userWelcome").textContent =
        `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${currentUser.name} (${currentUser.department})`;
      document.getElementById("pageTitle").textContent =
        currentUser.allDepartments && currentUser.allDepartments.length > 1
          ? `Ø¥Ø¯Ø§Ø±Ø© Ø£Ù‚Ø³Ø§Ù…: ${currentUser.allDepartments.join(" - ")}`
          : `Ù„ÙˆØ­Ø© Ù…Ø¯ÙŠØ± Ø§Ù„Ù‚Ø³Ù…`;

      appendMsg("bot", "Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯ SEVENSØŒ Ø§Ø³Ø£Ù„Ù†ÙŠ Ø£ÙŠ Ø´ÙŠØ¡ Ø¨Ø®ØµÙˆØµ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ğŸ¤–");

      // ØªÙ‡ÙŠØ¦Ø© Ø²Ø± Enter ÙÙŠ Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø¹Ø§Ù…
      const cbInput = document.getElementById("cbInput");
      cbInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendChat();
        }
      });

      // Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯
      const newRequestForm = document.getElementById('newRequestForm');
      newRequestForm.addEventListener('submit', handleNewRequestSubmit);

      // Ø¹Ø±Ø¶ Ø§Ø³Ù… Ù…Ù„Ù Ù…Ø±ÙÙ‚ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
      const chatAttachment = document.getElementById('chatAttachment');
      chatAttachment.addEventListener('change', e => {
        const file = e.target.files[0];
        const label = document.getElementById('selectedFileLabel');
        label.textContent = file ? `ğŸ“ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù: ${file.name}` : '';
      });

      // Ø¥ØºÙ„Ø§Ù‚ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
      window.addEventListener('click', (e) => {
        const dropdown = document.getElementById('deptDropdown');
        if (dropdown && !dropdown.contains(e.target)) {
          dropdown.classList.remove('active');
        }
      });

      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
      await loadEmployees();
      await loadDepartments();
      await loadRequestsForUser();

      // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ÙˆØ§Ø±Ø¯ ÙˆØ§Ù„Ù…Ø±Ø³Ù„
      setupIncomingOutgoingToggle();

      // ÙØ­Øµ Ø§Ù„Ø¬Ù„Ø³Ø© ÙƒÙ„ 20 Ø«Ø§Ù†ÙŠØ©
      setInterval(sessionCheck, 20000);

      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
      setInterval(loadRequestsForUser, 30000);

      // ØªØ­Ø¯ÙŠØ« Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„ØªØ°ÙƒØ±Ø© Ø§Ù„Ù…ÙØªÙˆØ­Ø© ÙƒÙ„ 10 Ø«ÙˆØ§Ù†Ù
      setInterval(refreshOpenTicketChat, 10000);
    });
  </script>
</body>
</html>