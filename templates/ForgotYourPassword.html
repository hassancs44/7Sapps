<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>نسيت كلمة المرور | SEVENS</title>

  <!-- الخطوط والأيقونات -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Tajawal', sans-serif;
    }

    body {
      background: linear-gradient(135deg, #1e88e5, #29b6f6);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      overflow-y: auto;
      position: relative;
    }

    body::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top,
              rgba(255,255,255,0.12) 0%,
              rgba(255,255,255,0) 70%);
      z-index: -1;
    }

    .container {
      width: 100%;
      max-width: 420px;
      background: rgba(255,255,255,0.96);
      border-radius: 24px;
      padding: 35px 25px;
      text-align: center;
      box-shadow: 0 25px 45px rgba(0,0,0,0.12);
      backdrop-filter: blur(12px);
      animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .logo-box {
      width: 120px;
      height: 120px;
      background: white;
      border-radius: 18px;
      margin: 0 auto 25px;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
      transition: 0.3s;
    }

    .logo-box:hover {
      transform: scale(1.05);
    }

    .login-title {
      color: #0d47a1;
      font-size: 26px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .subtitle {
      color: #666;
      font-size: 15px;
      margin-bottom: 28px;
      line-height: 1.6;
    }

    .input-field {
      text-align: right;
      margin-bottom: 18px;
    }

    .input-field input {
      width: 100%;
      padding: 14px 18px;
      border: 2px solid #e1ecf7;
      border-radius: 14px;
      font-size: 16px;
      outline: none;
      background: #fdfdfd;
      transition: 0.25s ease;
    }

    .input-field input:focus {
      border-color: #1976d2;
      box-shadow: 0 0 0 4px rgba(25,118,210,0.15);
    }

    .btn-send {
      width: 100%;
      margin-top: 10px;
      padding: 12px;
      background: #1976d2;
      color: white;
      border-radius: 12px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.25s;
    }

    .btn-send:hover:not(:disabled) {
      background: #125aa3;
      transform: translateY(-2px);
    }

    .btn-send:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-reset {
      width: 100%;
      margin-top: 18px;
      padding: 14px;
      background: linear-gradient(to right, #4caf50, #2e7d32);
      border: none;
      border-radius: 14px;
      color: white;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.25s ease;
      box-shadow: 0 4px 10px rgba(76,175,80,0.35);
    }

    .btn-reset:hover {
      transform: translateY(-2px);
      background: linear-gradient(to right, #43a047, #1b5e20);
    }

    .message {
      margin-top: 15px;
      padding: 12px;
      border-radius: 12px;
      display: none;
      font-weight: 600;
      font-size: 15px;
    }

    .success {
      background: #e8f5e9;
      color: #2e7d32;
      border: 1px solid #c8e6c9;
      display: block;
    }

    .error {
      background: #ffebee;
      color: #c62828;
      border: 1px solid #ffcdd2;
      display: block;
    }

    .back {
      margin-top: 20px;
      font-size: 14px;
    }

    .back a {
      color: #1e88e5;
      text-decoration: none;
      font-weight: 600;
    }
  </style>
</head>

<body>

<div class="container">

  <!-- Logo -->
  <div class="logo-box">
    <img src="{{ url_for('static', filename='7s.jpg') }}" width="80">
  </div>

  <div class="login-title">نسيت كلمة المرور؟</div>
  <div class="subtitle">أدخل بريدك الإلكتروني، رمز التحقق، ثم كلمة مرور جديدة.</div>

  <!-- Email -->
  <div class="input-field">
    <input type="email" id="email" placeholder="البريد الإلكتروني" />
    <button class="btn-send" id="otpBtn" onclick="sendOTP()">إرسال رمز التحقق</button>
  </div>

  <!-- OTP -->
  <div class="input-field">
    <input type="text" id="otp" placeholder="رمز التحقق (6 أرقام)" maxlength="6" />
  </div>

  <!-- New Password -->
  <div class="input-field">
    <input type="password" id="newPassword" placeholder="كلمة المرور الجديدة" />
  </div>

  <!-- Confirm Password -->
  <div class="input-field">
    <input type="password" id="confirmPassword" placeholder="تأكيد كلمة المرور الجديدة" />
  </div>

  <!-- Messages -->
  <div id="msg" class="message"></div>

  <!-- Reset Button -->
  <button class="btn-reset" onclick="resetPassword()">تحديث كلمة المرور</button>

  <div class="back">
    <a href="Login.html">← العودة لتسجيل الدخول</a>
  </div>

</div>

<script>

let timer = null;
let seconds = 60;

/* === Snackbar Messages === */
function showMessage(text, type) {
  const msg = document.getElementById("msg");
  msg.textContent = text;
  msg.className = "message " + type;
  msg.style.display = "block";

  setTimeout(() => msg.style.display = "none", 4500);
}

/* === OTP Timer === */
function startTimer() {
  const btn = document.getElementById("otpBtn");
  btn.disabled = true;

  seconds = 60;
  btn.textContent = `إعادة الإرسال بعد ${seconds} ثانية`;

  timer = setInterval(() => {
    seconds--;
    btn.textContent = `إعادة الإرسال بعد ${seconds} ثانية`;

    if (seconds <= 0) {
      clearInterval(timer);
      btn.disabled = false;
      btn.textContent = "إرسال رمز التحقق";
    }
  }, 1000);
}

/* === إرسال رمز التحقق === */
async function sendOTP() {
  const email = document.getElementById("email").value.trim();

  if (!email) return showMessage("يرجى إدخال البريد الإلكتروني", "error");

  try {
    const res = await fetch("/api/send_reset_code", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email })
    });

    const data = await res.json();
    if (data.success) {
      showMessage("تم إرسال رمز التحقق إلى بريدك", "success");
      startTimer();
    } else {
      showMessage(data.message || "لم يتم إرسال الرمز", "error");
    }

  } catch {
    showMessage("تعذر الاتصال بالخادم", "error");
  }
}

/* === إعادة تعيين كلمة المرور === */
async function resetPassword() {
  const email = document.getElementById("email").value.trim();
  const otp = document.getElementById("otp").value.trim();
  const pass1 = document.getElementById("newPassword").value;
  const pass2 = document.getElementById("confirmPassword").value;

  if (!email || !otp || !pass1 || !pass2)
    return showMessage("يرجى تعبئة جميع الحقول", "error");

  if (otp.length !== 6)
    return showMessage("رمز التحقق يجب أن يكون 6 أرقام", "error");

  if (pass1 !== pass2)
    return showMessage("كلمتا المرور غير متطابقتين", "error");

  if (pass1.length < 4)
    return showMessage("كلمة المرور قصيرة جدًا", "error");

  // Verify code
  const verifyRes = await fetch("/api/verify_reset_code", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ code: otp })
  });

  const verifyData = await verifyRes.json();
  if (!verifyData.success)
    return showMessage("رمز التحقق غير صحيح", "error");

  // Reset password
  try {
    const res = await fetch("/api/forgot_reset_password", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, otp, newPassword: pass1 })
    });

    const data = await res.json();
    if (data.success) {
      showMessage("تم تغيير كلمة المرور بنجاح", "success");

      setTimeout(() => {
        window.location.href = "Login.html";
      }, 2500);
    } else {
      showMessage(data.message || "حدث خطأ أثناء التحديث", "error");
    }

  } catch {
    showMessage("تعذر الاتصال بالخادم", "error");
  }
}

</script>

</body>
</html>
