<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>STOR7S | Ø§Ù„Ù…Ø§Ù„ÙŠØ© (Finance)</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');

*,
*::before,
*::after{
  box-sizing:border-box;
}

body{
  margin:0;
  font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial;
  color:#0B1220;
  background:#F1F5F9;
}

.topbar{
  background:#FFFFFF;
  padding:16px 18px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-bottom:1px solid rgba(15,23,42,.10);
  box-shadow:0 6px 18px rgba(2,6,23,.08);
}
.topbar *{
  color:#0B1220;
  font-weight:700;
}

.btn{
  background:linear-gradient(180deg,#0B5ED7,#0A3E9A);
  border:0;
  padding:10px 14px;
  border-radius:14px;
  color:#fff;
  cursor:pointer;
  font-weight:600;
  box-shadow:0 8px 18px rgba(11,94,215,.22);
}

.card{
  background:#FFFFFF;
  padding:20px;
  border-radius:18px;
  margin:14px auto;
  max-width:1200px;
  border:1px solid rgba(15,23,42,.10);
  box-shadow:0 14px 40px rgba(2,6,23,.10);
}

input,select{
  width:100%;
  max-width:100%;
  display:block;

  padding:12px 14px;
  margin-top:6px;
  border-radius:14px;
  background:#FFFFFF;
  color:#0B1220;
  border:1px solid rgba(15,23,42,.10);
  font-size:14px;
}
input:focus,select:focus{
  outline:none;
  border-color:rgba(11,94,215,.5);
  box-shadow:0 0 0 4px rgba(11,94,215,.12);
}

table{
  width:100%;
  max-width:100%;
  border-collapse:collapse;
  margin-top:14px;
  border-radius:14px;
  overflow:hidden;
  background:#FFFFFF;
}

th,td{
  padding:12px;
  border-bottom:1px solid rgba(15,23,42,.08);
  font-size:14px;
  color:#0B1220;
}

</style>
</head>

<body>

<div class="topbar">
  <div>ğŸ’° STOR7S | Ø§Ù„Ù…Ø§Ù„ÙŠØ© (Ø±Ù‚Ø§Ø¨Ø© ÙÙ‚Ø·)</div>
  <button class="btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
</div>

<div class="card">
  <h3>â• Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ </h3>

  <input id="req_desc" placeholder="ÙˆØµÙ Ø§Ù„Ø·Ù„Ø¨">
  <input id="req_company" placeholder="Ø§Ù„Ø´Ø±ÙƒØ©">
  <input id="req_branch" placeholder="Ø§Ù„ÙØ±Ø¹">

  <button class="btn" onclick="createRequest()">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
</div>

  <h2>ğŸ“Š ÙØ­Øµ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h2>
  <input id="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ / Ø§Ù„Ù…ÙˆØ±Ø¯ / Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡" onkeyup="filterData()">
  <button class="btn" onclick="loadData()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
  <h3>ğŸ§¾ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø´Ø±Ø§Ø¡</h3>
<table id="finTable">
  <thead>
    <tr>
      <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
      <th>Ø§Ù„Ù…ÙˆØ±Ø¯</th>
      <th>Ø§Ù„Ø³Ø¹Ø±</th>
      <th>Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
      <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
      <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
      <th>Ø¹Ø±Ø¶</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

</div>

<script>
const API = "/api/core/finance";

async function loadData(){
  let res = await fetch(API+"/purchases");
  let data = await res.json();

  let rows = "";
  for(let r of data){
    rows += `
    <tr>
      <td>${r.Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨}</td>
      <td>${r.Ø§Ù„Ù…ÙˆØ±Ø¯}</td>
      <td>${r.Ø§Ù„Ø³Ø¹Ø±}</td>
      <td>${r.Ø§Ù„ÙØ§ØªÙˆØ±Ø©}</td>
      <td>${r.ØªØ§Ø±ÙŠØ®_Ø§Ù„ÙØ§ØªÙˆØ±Ø©}</td>
      <td>${r.Ø§Ù„Ø­Ø§Ù„Ø©}</td>
      <td>
        <button class="btn" onclick="viewFiles('${r.Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨}')">ğŸ“ Ù…Ø±ÙÙ‚Ø§Øª</button>
      </td>
    </tr>`;
  }

  document.querySelector("#finTable tbody").innerHTML = rows;
}


function filterData(){
  let q = document.getElementById("search").value.toLowerCase();
  document.querySelectorAll("#finTable tbody tr").forEach(r=>{
    r.style.display = r.textContent.toLowerCase().includes(q) ? "" : "none";
  });
}

function logout(){
  localStorage.clear();
  window.location.href = "/Login.html";
}


// ØªØ­Ù…ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ
loadData();

    async function viewFiles(id){
  let res = await fetch(API+"/attachments/"+id);
  let files = await res.json();

  if(files.length === 0){
    alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚Ø§Øª");
    return;
  }

  let list = files.map(f =>
    `ğŸ“ ${f.Ø§Ø³Ù…_Ø§Ù„Ù…Ù„Ù}`
  ).join("\n");

  alert(list);
}

    async function createRequest(){
  const desc = document.getElementById("req_desc").value;
  const company = document.getElementById("req_company").value;
  const branch = document.getElementById("req_branch").value;

  if(!desc){
    alert("âš ï¸ Ø£Ø¯Ø®Ù„ ÙˆØµÙ Ø§Ù„Ø·Ù„Ø¨");
    return;
  }

  let res = await fetch(API+"/create-request",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      Ø§Ù„ÙˆØµÙ: desc,
      Ø§Ù„Ø´Ø±ÙƒØ©: company,
      Ø§Ù„ÙØ±Ø¹: branch
    })
  });

  let r = await res.json();
  alert(r.msg);

  document.getElementById("req_desc").value = "";
}

</script>

</body>
</html>
