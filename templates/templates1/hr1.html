<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>STOR7S | Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ© (HR)</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
*,
*::before,
*::after{
  box-sizing:border-box;
}

body{
  margin:0;
  font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial;
  color:#0B1220;
  background:#F7FAFF;
}

.topbar{
  background:#FFFFFF;
  padding:16px 18px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-bottom:1px solid rgba(15,23,42,.10);
  box-shadow:0 6px 18px rgba(2,6,23,.08);
}
.topbar *{
  color:#0B1220;
  font-weight:700;
}

.btn{
  background:linear-gradient(180deg,#0B5ED7,#0A3E9A);
  border:0;
  padding:10px 14px;
  border-radius:14px;
  color:#fff;
  cursor:pointer;
  font-weight:600;
  box-shadow:0 8px 18px rgba(11,94,215,.22);
}

.btn.red{
  background:linear-gradient(180deg,#DC2626,#991B1B);
}

.btn.green{
  background:linear-gradient(180deg,#16A34A,#15803D);
}

.btn.yellow{
  background:linear-gradient(180deg,#F59E0B,#D97706);
}

.card{
  background:#FFFFFF;
  padding:20px;
  border-radius:18px;
  margin:14px auto;
  max-width:1200px;
  border:1px solid rgba(15,23,42,.10);
  box-shadow:0 14px 40px rgba(2,6,23,.10);
}

input,select,textarea{
  width:100%;
  max-width:100%;
  display:block;

  padding:12px 14px;
  margin-top:6px;
  border-radius:14px;
  background:#FFFFFF;
  color:#0B1220;
  border:1px solid rgba(15,23,42,.10);
  font-size:14px;
}
input:focus,select:focus,textarea:focus{
  outline:none;
  border-color:rgba(11,94,215,.5);
  box-shadow:0 0 0 4px rgba(11,94,215,.12);
}

table{
  width:100%;
  max-width:100%;
  border-collapse:collapse;
  margin-top:14px;
  border-radius:14px;
  overflow:hidden;
  background:#FFFFFF;
}

th,td{
  padding:12px;
  border-bottom:1px solid rgba(15,23,42,.08);
  font-size:14px;
  color:#0B1220;
}
th{
  background:#F1F5F9;
  font-weight:700;
}

</style>
</head>

<body>

<div class="topbar">
  <div>ğŸŸ¥ STOR7S | Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ© (HR)</div>
  <button class="btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
</div>

<nav style="display:flex;gap:10px;margin:10px;">
  <button class="btn" onclick="loadAll()">ğŸ“Œ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‡Ø¯</button>
  <button class="btn" onclick="showAdd()">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù‡Ø¯Ø©</button>
  <button class="btn" onclick="showTransfer()">ğŸ” Ù†Ù‚Ù„ Ø¹Ù‡Ø¯Ø©</button>
  <button class="btn" onclick="showClose()">ğŸš« Ø¥Ù‚ÙØ§Ù„ Ø¹Ù‡Ø¯Ø©</button>
    <button class="btn" onclick="showRequest()">ğŸ§¾ Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡</button>
</nav>

<div id="request" class="card" style="display:none;">
  <h2>ğŸ§¾ Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡ (HR)</h2>
  <textarea id="r_desc" placeholder="ÙˆØµÙ Ø§Ù„Ø·Ù„Ø¨"></textarea>
  <button class="btn green" onclick="createRequest()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
</div>

<!-- ================= Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‡Ø¯ ================= -->
<div id="list" class="card">
  <h2>ğŸ“Œ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‡Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h2>
  <table id="tbl"><tbody></tbody></table>
</div>

<!-- ================= Ø¥Ø¶Ø§ÙØ© Ø¹Ù‡Ø¯Ø© ================= -->
<div id="add" class="card" style="display:none;">
  <h2>â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù‡Ø¯Ø© ÙŠØ¯ÙˆÙŠØ©</h2>
  <input id="a_emp" placeholder="Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³ØªÙÙŠØ¯">
<textarea id="a_items" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ù‡Ø¯ (ÙƒÙ„ Ø³Ø·Ø± ØµÙ†Ù)
Ù…Ø«Ø§Ù„:
Laptop
Phone
Screen"></textarea>
<button class="btn green" onclick="addMultiCustody()">Ø­ÙØ¸ Ø§Ù„Ø¹Ù‡Ø¯</button>

</div>

<!-- ================= Ù†Ù‚Ù„ Ø¹Ù‡Ø¯Ø© ================= -->
<div id="transfer" class="card" style="display:none;">
  <h2>ğŸ” Ù†Ù‚Ù„ Ø¹Ù‡Ø¯Ø©</h2>
  <input id="t_id" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨/Ø§Ù„Ø¹Ù‡Ø¯Ø©">
  <input id="t_new_emp" placeholder="Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯">
  <button class="btn yellow" onclick="transferCustody()">ØªÙ†ÙÙŠØ° Ø§Ù„Ù†Ù‚Ù„</button>
</div>

<!-- ================= Ø¥Ù‚ÙØ§Ù„ Ø¹Ù‡Ø¯Ø© ================= -->
<div id="close" class="card" style="display:none;">
  <h2>ğŸš« Ø¥Ù‚ÙØ§Ù„ Ø¹Ù‡Ø¯Ø©</h2>
  <input id="c_id" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨/Ø§Ù„Ø¹Ù‡Ø¯Ø©">
  <button class="btn red" onclick="closeCustody()">Ø¥Ù‚ÙØ§Ù„ Ù†Ù‡Ø§Ø¦ÙŠ</button>
</div>

<script>
const API = "/api/core/hr";
let USER = {};

async function loadUserSession(){
  try{
    const r = await fetch("/api/session", { credentials:"include" });
    if(!r.ok) throw new Error("no session");
    USER = await r.json();

    // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ù†Ø®Ø²Ù†Ù‡ Ù„Ù„Ù…Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©
    localStorage.setItem("user", JSON.stringify(USER));
  }catch(e){
    USER = JSON.parse(localStorage.getItem("user")||"{}");
  }
}


// ================= ÙˆØ§Ø¬Ù‡Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¹Ø±Ø¶ =================
function showRequest(){ hideAll(); document.getElementById("request").style.display="block"; }
function showTransfer(){hideAll(); document.getElementById("transfer").style.display="block";}
function showClose(){hideAll(); document.getElementById("close").style.display="block";}
function hideAll(){
  document.getElementById("add").style.display="none";
  document.getElementById("transfer").style.display="none";
  document.getElementById("close").style.display="none";
}

// ================= Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù‡Ø¯ =================
async function loadAll(){
  let res = await fetch(API+"/custody/all");
  let data = await res.json();

  let rows = `
    <tr>
      <th>Ø±Ù‚Ù…</th>
      <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
      <th>Ø§Ù„Ù‚Ø³Ù…</th>
      <th>Ø§Ù„Ù†ÙˆØ¹</th>
      <th>Ø§Ù„ØµÙ†Ù</th>
<th>Ø§Ù„Ø³ÙŠØ±ÙŠØ§Ù„</th>
<th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>

      <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
    </tr>
  `;

  data.forEach(r=>{
    rows+=`
<tr>
  <td>${r.Ø±Ù‚Ù…_Ø§Ù„Ø¹Ù‡Ø¯Ø©}</td>
  <td>${r.Ø§Ù„Ù…ÙˆØ¸Ù}</td>
  <td>${r.Ø§Ù„Ù‚Ø³Ù…}</td>
  <td>${r.Ù†ÙˆØ¹_Ø§Ù„Ø¹Ù‡Ø¯Ø©}</td>
  <td>${r.Ø§Ø³Ù…_Ø§Ù„ØµÙ†Ù || "-"}</td>
  <td>${r.Ø³ÙŠØ±ÙŠØ§Ù„ || "-"}</td>
  <td>${r.Ø§Ù„ÙƒÙ…ÙŠØ©}</td>
  <td>
  ${r.Ø§Ù„Ø­Ø§Ù„Ø©}
  <br>
  <button class="btn green" onclick="receive('${r.Ø±Ù‚Ù…_Ø§Ù„Ø¹Ù‡Ø¯Ø©}')">Ø§Ø³ØªÙ„Ø§Ù…</button>
  <button class="btn yellow" onclick="dispatch('${r.Ø±Ù‚Ù…_Ø§Ù„Ø¹Ù‡Ø¯Ø©}')">ØªØ³Ù„ÙŠÙ…</button>
</td>
</tr>
`;

  });

  document.querySelector("#tbl").innerHTML = rows;
}

// ================= Ø¥Ø¶Ø§ÙØ© Ø¹Ù‡Ø¯Ø© =================
async function addCustody(){
  let data = {
    Ø±Ù‚Ù…_Ø§Ù„Ø¹Ù‡Ø¯Ø©: "CST-" + Date.now(),
    Ø§Ù„Ù…ÙˆØ¸Ù: document.getElementById("a_emp").value,
    Ø§Ù„Ù‚Ø³Ù…: USER.department,
    Ù†ÙˆØ¹_Ø§Ù„Ø¹Ù‡Ø¯Ø©: document.getElementById("a_type").value,
    Ø³ÙŠØ±ÙŠØ§Ù„: document.getElementById("a_serial").value,
    Ø§Ù„ÙƒÙ…ÙŠØ©: 1,
    Ù…Ù„Ø§Ø­Ø¸Ø§Øª: document.getElementById("a_note").value
  };

  let r = await fetch(API+"/custody/add",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(data)
  });

  let res = await r.json();
  if(res.ok){
    alert("âœ”ï¸ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù‡Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­");
    loadAll();
  }
}


// ================= Ù†Ù‚Ù„ Ø¹Ù‡Ø¯Ø© =================
async function transferCustody(){
  let data = {
  Ø±Ù‚Ù…_Ø§Ù„Ø¹Ù‡Ø¯Ø©: document.getElementById("t_id").value,
  Ø§Ù„Ù…ÙˆØ¸Ù: document.getElementById("t_new_emp").value
};


  let r = await fetch(API+"/custody/transfer",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(data)
  });

  if(r.ok){
    alert("âœ”ï¸ ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø¹Ù‡Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­");
    loadAll();
  }
}


// ================= Ø¥Ù‚ÙØ§Ù„ Ø¹Ù‡Ø¯Ø© =================
async function closeCustody(){
  const cid = document.getElementById("c_id").value.trim();
  if(!cid) return alert("Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‡Ø¯Ø©");

  let r = await fetch(API+"/custody/close",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ Ø±Ù‚Ù…_Ø§Ù„Ø¹Ù‡Ø¯Ø©: cid })
  });

  let res = await r.json();
  if(res.ok){
    alert("âœ”ï¸ ØªÙ… Ø§Ù‚ÙØ§Ù„ Ø§Ù„Ø¹Ù‡Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­");
    document.getElementById("c_id").value="";
    loadAll();
  }else{
    alert(res.msg || "Ø­Ø¯Ø« Ø®Ø·Ø£");
  }
}


// ================= ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ =================
function logout(){localStorage.clear();location.reload();}


// ØªØ­Ù…ÙŠÙ„
(async ()=>{
  await loadUserSession();
  await loadAll();
})();


    async function createRequest(){
  let data = {
    Ø§Ù„Ø±Ø§ÙØ¹: USER.name,
    Ø§Ù„Ù‚Ø³Ù…: USER.department,
    Ø§Ù„Ø´Ø±ÙƒØ©: USER.company,
    Ø§Ù„ÙØ±Ø¹: USER.branch,
    Ø§Ù„Ù†ÙˆØ¹: "Ø´Ø±Ø§Ø¡",
    Ø§Ù„ÙˆØµÙ: document.getElementById("r_desc").value
  };

  let r = await fetch(API+"/request/create",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(data)
  });

  let res = await r.json();
  if(res.ok){
    alert("âœ”ï¸ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø±Ù‚Ù… " + res.Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨);
    document.getElementById("r_desc").value="";
  }
}


    async function addMultiCustody(){
  let items = document.getElementById("a_items").value
    .split("\n")
    .filter(x=>x.trim())
    .map(x=>({ Ø§Ø³Ù…:x.trim() }));

  let data = {
  Ø§Ù„Ù…ÙˆØ¸Ù: document.getElementById("a_emp").value,
  items: items
};



  let r = await fetch(API+"/custody/add-multi",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(data)
  });

  let res = await r.json();
  if(res.ok){
    alert("âœ”ï¸ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù‡Ø¯");
    loadAll();
  }
}


    async function receive(id){
  await fetch(API+"/custody/receive",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({Ø±Ù‚Ù…_Ø§Ù„Ø¹Ù‡Ø¯Ø©:id})
  });
  loadAll();
}

async function dispatch(id){
  await fetch(API+"/custody/dispatch",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({Ø±Ù‚Ù…_Ø§Ù„Ø¹Ù‡Ø¯Ø©:id})
  });
  loadAll();
}

    function showAdd(){
  hideAll();
  document.getElementById("add").style.display="block";
}

</script>

</body>
</html>
