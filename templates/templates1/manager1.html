<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>STOR7S | Ù…Ø¯ÙŠØ± Ø§Ù„Ù‚Ø³Ù…</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
*,
*::before,
*::after{
  box-sizing:border-box;
}

body{
  margin:0;
  font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial;
  color:#0B1220;
  background:#F1F5F9;
}

.topbar{
  background:#FFFFFF;
  padding:16px 18px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-bottom:1px solid rgba(15,23,42,.10);
  box-shadow:0 6px 18px rgba(2,6,23,.08);
}
.topbar *{
  color:#0B1220;
  font-weight:700;
}

.btn{
  background:linear-gradient(180deg,#0B5ED7,#0A3E9A);
  border:0;
  padding:10px 14px;
  border-radius:14px;
  color:#fff;
  cursor:pointer;
  font-weight:600;
  box-shadow:0 8px 18px rgba(11,94,215,.22);
}

.btn.red{
  background:linear-gradient(180deg,#DC2626,#991B1B);
}

.card{
  background:#FFFFFF;
  padding:20px;
  border-radius:18px;
  margin:14px auto;
  max-width:1200px;
  border:1px solid rgba(15,23,42,.10);
  box-shadow:0 14px 40px rgba(2,6,23,.10);
}

input,select,textarea{
  width:100%;
  max-width:100%;
  display:block;

  padding:12px 14px;
  margin-top:6px;
  border-radius:14px;
  background:#FFFFFF;
  color:#0B1220;
  border:1px solid rgba(15,23,42,.10);
  font-size:14px;
}
input:focus,select:focus,textarea:focus{
  outline:none;
  border-color:rgba(11,94,215,.5);
  box-shadow:0 0 0 4px rgba(11,94,215,.12);
}

table{
  width:100%;
  max-width:100%;
  border-collapse:collapse;
  margin-top:14px;
  border-radius:14px;
  overflow:hidden;
  background:#FFFFFF;
}

th,td{
  padding:12px;
  border-bottom:1px solid rgba(15,23,42,.08);
  font-size:14px;
  color:#0B1220;
}
th{
  background:#F1F5F9;
  font-weight:700;
}

</style>
</head>

<body>

<!-- ====================== HEADER ====================== -->
<div class="topbar">
  <div>ğŸ“Œ STOR7S | ØµÙØ­Ø© Ù…Ø¯ÙŠØ± Ø§Ù„Ù‚Ø³Ù…</div>
  <button class="btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
</div>

<!-- ====================== Ø§Ù„Ø·Ù„Ø¨Ø§Øª ====================== -->
<div class="card">
  <h3>ğŸ” Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ø¹ØªÙ…Ø§Ø¯Ùƒ</h3>
  <input id="dept" disabled style="background:#162544;color:#bbb">
  <button class="btn" onclick="loadPending(document.getElementById('dept').value)">Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
  <table id="tbl">
    <thead>
      <tr>
        <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
        <th>Ø§Ù„Ù‚Ø³Ù…</th>
        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
        <th>Ø§Ø¹ØªÙ…Ø§Ø¯</th>
        <th>Ø±ÙØ¶</th>
        <th>Ù…Ø±ÙÙ‚Ø§Øª</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>


<!-- ====================== Ø±ÙØ¹ Ø·Ù„Ø¨ ====================== -->
<div class="card">
  <h3>ğŸ“ Ø±ÙØ¹ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ (ÙŠØ¹ØªÙ…Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙˆÙŠØ±Ø³Ù„ Ù„Ù„Ù…Ø´ØªØ±ÙŠØ§Øª)</h3>
  <input id="m_name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ±" disabled>
  <input id="m_dept" placeholder="Ø§Ù„Ù‚Ø³Ù…" disabled>
  <input id="m_branch" placeholder="Ø§Ù„ÙØ±Ø¹" disabled>
  <select id="m_type">
    <option>Ù…ÙˆØ§Ø¯</option><option>Ø£Ø¬Ù‡Ø²Ø©</option>
    <option>Ø®Ø¯Ù…Ø§Øª</option><option>ØµÙŠØ§Ù†Ø©</option>
  </select>
  <textarea id="m_desc" placeholder="ÙˆØµÙ Ø§Ù„Ø·Ù„Ø¨"></textarea>
  <button class="btn" onclick="createReq()">Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø¨</button>
</div>


<script>
/* ========================== API LINKS ========================== */
const API = "/api/core/manager";
const EMP = "http://localhost:5000/api/employee"; // Ù„Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ù…Ø³Ø§Ø± Ø§Ù„Ù…ÙˆØ¸Ù
const PURCH = "/api/core/purchasing";

/* ========================== Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„ ========================== */
let CURRENT_USER = null;

document.addEventListener("DOMContentLoaded", async () => {
  try {
    const res = await fetch("/api/auth/session_check");
    const data = await res.json();

    if (!data.valid) {
      location.href = "/Login.html";
      return;
    }

    const user = data.user;
    CURRENT_USER = user; // âœ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…

    document.getElementById("dept").value = user.department || "";
    document.getElementById("m_name").value = user.name || "";
    document.getElementById("m_dept").value = user.department || "";
    document.getElementById("m_branch").value = user.branch || "";

    loadPending(user.department);

  } catch (e) {
    console.error(e);
    location.href = "/Login.html";
  }
});

/* ========================== Ø¹Ø±Ø¶ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù‚Ø³Ù… ========================== */
async function loadPending(dept) {
  if (!dept) return;

  const r = await fetch(`/api/core/manager/pending/${encodeURIComponent(dept)}`);
  const data = await r.json();

  const rows = data.map(r => `
    <tr>
      <td>${r["Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨"]}</td>
      <td>${r["Ø§Ù„Ù‚Ø³Ù…"]}</td>
      <td>${r["Ø§Ù„Ø­Ø§Ù„Ø©"]}</td>
      <td>
        <button class="btn" onclick="approve('${r["Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨"]}')">âœ”ï¸ Ø§Ø¹ØªÙ…Ø§Ø¯</button>
      </td>
      <td>
        <button class="btn red" onclick="reject('${r["Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨"]}')">âŒ Ø±ÙØ¶</button>
      </td>
      <td>
        <button class="btn" onclick="showAttachments('${r["Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨"]}')">ğŸ“ Ù…Ø±ÙÙ‚Ø§Øª</button>
      </td>
    </tr>
  `).join("");

  document.querySelector("#tbl tbody").innerHTML = rows;
}


/* ========================== Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø·Ù„Ø¨ + ØªØ­ÙˆÙŠÙ„Ù‡ ========================== */
async function approve(id){
  await fetch(`${API}/approve`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨:id})
  });

  alert("âœ”ï¸ ØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ ÙˆØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ù…Ø´ØªØ±ÙŠØ§Øª");

  // âœ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¨Ø§Ù„Ù‚Ø³Ù…
  loadPending(document.getElementById("dept").value);
}

/* ========================== Ø§Ù„Ø±ÙØ¶ ========================== */
async function reject(id){
  let reason = prompt("Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶:");
  alert(`âŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ Ø±Ù‚Ù… ${id}\nğŸ“Œ Ø§Ù„Ø³Ø¨Ø¨: ${reason}`);
}

/* ========================== Ø±ÙØ¹ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…Ø¯ÙŠØ± ========================== */
async function createReq(){
  if(!CURRENT_USER){
    alert("âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
    return;
  }

  let form = new FormData();
  form.append("Ø§Ù„Ø±Ø§ÙØ¹", CURRENT_USER.name);
  form.append("Ø§Ù„Ø¯ÙˆØ±", "Ù…Ø¯ÙŠØ± Ø§Ù„Ù‚Ø³Ù…");
  form.append("Ø§Ù„Ù‚Ø³Ù…", CURRENT_USER.department);
  form.append("Ø§Ù„Ø´Ø±ÙƒØ©", CURRENT_USER.company || "");
  form.append("Ø§Ù„ÙØ±Ø¹", CURRENT_USER.branch || "");
  form.append("Ø§Ù„Ù†ÙˆØ¹", document.getElementById("m_type").value);
  form.append("Ø§Ù„ÙˆØµÙ", document.getElementById("m_desc").value);
  form.append("Ø§Ù„Ø­Ø§Ù„Ø©", "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª");

  try {
    let res = await fetch("/api/core/employee/create", {
      method:"POST",
      body:form
    });

    let data = await res.json();

    alert("ğŸš€ ØªÙ… Ø±ÙØ¹ ÙˆØ§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø·Ù„Ø¨ Ø±Ù‚Ù…: " + data["Ø±Ù‚Ù…_Ø§Ù„Ø·Ù„Ø¨"]);

    document.getElementById("m_desc").value = "";
    loadPending(CURRENT_USER.department);

  } catch (e){
    console.error(e);
    alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„Ø·Ù„Ø¨");
  }
}

/* ========================== Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø·Ù„Ø¨ ========================== */
async function showAttachments(id){
  let res = await fetch(`http://localhost:5000/api/employee/attachments/${id}`);
  let files = await res.json();

  if(!files.length){
    alert("ğŸ“­ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚Ø§Øª");
    return;
  }

  let html = files.map(f => `
    ğŸ“„ <a href="/uploads/${f}" target="_blank" style="color:#3b82f6;">
      ${f}
    </a>
  `).join("<br>");

  alert("ğŸ“ Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø·Ù„Ø¨:\n\n" + html);
}


/* ========================== ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ ========================== */
function logout(){ localStorage.clear(); location.href="login.html"; }

</script>

</body>
</html>
