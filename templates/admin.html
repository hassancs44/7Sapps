<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† | SEVENS</title>
<!-- PWA -->
<link rel="manifest" href="/static/manifest.json">
<meta name="theme-color" content="#1976d2">

<!-- iOS Web App -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="SEVENS">

<link rel="apple-touch-icon" sizes="180x180" href="/static/icons/ios/180.png">
<link rel="apple-touch-icon" sizes="167x167" href="/static/icons/ios/167.png">
<link rel="apple-touch-icon" sizes="152x152" href="/static/icons/ios/152.png">
<link rel="apple-touch-icon" sizes="120x120" href="/static/icons/ios/120.png">

  <!-- Ø®Ø·ÙˆØ· ÙˆØ£ÙŠÙ‚ÙˆÙ†Ø§Øª -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    :root{
      --blue-50:#e3f2fd; --blue-100:#bbdefb; --blue-200:#90caf9; --blue-300:#64b5f6;
      --blue-400:#42a5f5; --blue-500:#2196f3; --blue-600:#1e88e5; --blue-700:#1976d2;
      --sky:#f8fbff; --ink:#2c3e50; --muted:#607d8b; --line:#eef5ff;
      --green:#43a047; --red:#e53935; --amber:#ffb300; --shadow: rgba(0,0,0,.06);
    }

    *{
      margin:0;
      padding:0;
      box-sizing:border-box;
      font-family:'Tajawal',sans-serif
    }

    body{
      background:var(--sky);
      color:var(--ink);
      min-height:100vh
        padding-bottom: env(safe-area-inset-bottom);
  -webkit-tap-highlight-color: transparent;

    }

    /* Navbar */
    .navbar{
      background:#fff;
      padding:16px 24px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      box-shadow:0 2px 12px var(--shadow);
      position:sticky;
      top:0;
      z-index:100
        flex-wrap: wrap;
  gap: 10px;
    }
    .logo-box{display:flex;align-items:center;gap:12px}
    .logo-box img{width:40px;height:40px;object-fit:contain;border-radius:10px}
    .logo-box h1{color:var(--blue-600);font-size: clamp(16px, 4vw, 20px);font-weight:700}
    .user-info{display:flex;align-items:center;gap:12px;color:#34495e;font-weight:600}
    .logout-btn{
      background:#e3f2fd;
      color:#1976d2;
      border:none;
      padding:6px 14px;
      border-radius:8px;
      font-weight:600;
      cursor:pointer
    }
    .logout-btn:hover{background:#bbdefb}

    .container{max-width:1220px;margin:24px auto;padding:0 16px}

    /* ===== Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© ===== */
    .stats-bar{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:12px;
      margin-bottom:18px;
    }
    .stat-card{
      background:#fff;
      border-radius:14px;
      padding:12px 14px;
      box-shadow:0 3px 10px var(--shadow);
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .stat-label{
      font-size:13px;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:6px;
    }
    .stat-label i{font-size:14px;}
    .stat-value{
      font-size:20px;
      font-weight:700;
      color:var(--blue-700);
    }
    .stat-pill{
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      background:var(--blue-50);
      color:var(--blue-700);
      align-self:flex-start;
    }
    .stat-card--new .stat-value{color:#1976d2;}
    .stat-card--progress .stat-value{color:#ff9800;}
    .stat-card--closed .stat-value{color:#43a047;}
    .stat-card--archived .stat-value{color:#757575;}

    /* Tabs */
    .tabs{display:flex;gap:10px;margin-bottom:18px;flex-wrap:wrap}
    .tab-btn{
      padding:10px 14px;
      border:2px solid var(--blue-50);
      border-radius:10px;
      background:#fff;
      color:#1565c0;
      font-weight:700;
      cursor:pointer
    }
    .tab-btn.active{
      background:linear-gradient(90deg,var(--blue-500),var(--blue-700));
      color:#fff;
      border-color:transparent
    }
    .tab{display:none}
    .tab.active{display:block}

    .section-title{
      font-size:22px;
      color:var(--blue-600);
      margin:20px 0 12px;
      padding-bottom:10px;
      border-bottom:2px solid var(--blue-50);
      display:flex;
      align-items:center;
      gap:10px
    }

    /* Filters & Buttons */
    .filters{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-bottom:12px
    }
    .form-control{
      padding:10px;
      border:2px solid var(--blue-50);
      border-radius:10px;
      background:#fff
    }
    .btn{
      padding:10px 14px;
      border:none;
      border-radius:10px;
      font-weight:700;
      cursor:pointer
    }
    .btn-primary{background:linear-gradient(90deg,var(--blue-500),var(--blue-700));color:#fff}
    .btn-green{background:var(--green);color:#fff}
    .btn-danger{background:var(--red);color:#fff}
    .btn-outline{background:#fff;border:2px solid var(--blue-50);color:#1565c0}

    /* Requests grid (cards) */
    .requests-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
  gap:16px
}

    .request-card{
      background:#fff;
      border-radius:18px;
      border:1px solid #e3f2fd;
      box-shadow:0 4px 10px rgba(0,0,0,.08);
      transition:.3s;
      text-align:right;
      padding:18px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      position:relative
    }
    .request-card:hover{transform:translateY(-5px);box-shadow:0 8px 20px rgba(30,136,229,.18)}

    .status-header{height:6px;border-radius:12px 12px 0 0}
    .status-new{background:#2196f3}
    .status-in-progress{background:#ff9800}
    .status-closed{background:#4caf50}
    .status-rejected{background:#f44336}
    .status-archived{background:#757575}

    .card-content{padding:10px 0}
    .request-title{font-size:18px;margin:8px 0 10px;color:#0d47a1;font-weight:700}
    .request-meta{display:flex;flex-wrap:wrap;gap:12px;color:#455a64;font-size:14px;margin-bottom:10px}
    .status-badge{display:inline-block;padding:4px 10px;border-radius:16px;font-size:12px;color:#fff}
    .no-requests{text-align:center;color:#7f8c8d;padding:18px}

    /* Users table */
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    thead th{
      background:#eaf3ff;
      color:#0d47a1;
      padding:10px;
      border-radius:10px;
      font-size:14px
    }
    tbody td{background:#fff;padding:10px;border:1px solid var(--line)}
    tbody tr{box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .action-btns{display:flex;gap:6px;flex-wrap:wrap}

    /* Modal */
    .modal{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.45);
      justify-content:center;
      align-items:center;
      z-index:2000
    }
    .modal-content{
      background:#fff;
      width:90%;
      max-width:560px;
      border-radius:16px;
      padding:20px 18px
    }

    /* Toast */
    .toast{
      position:fixed;
      bottom:30px;
      left:50%;
      transform:translateX(-50%);
      padding:12px 25px;
      border-radius:10px;
      color:#fff;
      font-size:15px;
      opacity:0;
      transition:all .4s ease;
      z-index:9999
    }
    .toast.show{opacity:1;bottom:50px}
    .toast.success{background:#4caf50}
    .toast.error{background:#e74c3c}
    .toast.info{background:#3498db}

      /* ğŸ“± Mobile adjustments */
@media (max-width: 768px){
  .container{
    padding: 0 10px;
  }

  .tabs{
    gap:6px;
  }

  .tab-btn{
    padding:8px 10px;
    font-size:14px;
  }

  .request-card{
    padding:14px;
  }

  .request-title{
    font-size:16px;
  }

  table thead{
    display:none;
  }

  table tbody tr{
    display:block;
    margin-bottom:10px;
  }

  table tbody td{
    display:block;
    width:100%;
  }
}

  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar">
    <div class="logo-box">
      <img src="{{ url_for('static', filename='7s.jpg') }}" alt="logo">
      <h1>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</h1>
    </div>
    <div class="user-info">
      <span id="userWelcome">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
      <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬</button>
    </div>
  </nav>

  <div class="container">
    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
    <div class="stats-bar" id="statsBar">
      <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ Ù…Ù† Ø¬Ø§ÙØ§Ø³ÙƒØ±Ø¨Øª -->
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" onclick="openTab('tab-requests', this)"><i class="fas fa-list"></i> Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
      <button class="tab-btn" onclick="openTab('tab-users', this)"><i class="fas fa-users"></i> Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>
      <button class="tab-btn" onclick="openTab('tab-departments', this)"><i class="fas fa-building"></i> Ø§Ù„Ø¥Ø¯Ø§Ø±Ø§Øª</button>
    </div>

    <!-- === Requests Tab === -->
    <div id="tab-requests" class="tab active">
      <div class="section-title"><i class="fas fa-inbox"></i> Ø¥Ø¯Ø§Ø±Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>

      <div class="filters">
        <input id="reqSearch" class="form-control"
               placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ / Ø§Ù„Ø¹Ù†ÙˆØ§Ù† / Ø§Ù„Ù‚Ø³Ù…"
               oninput="renderRequests()" style="min-width:260px">

        <select id="reqStatusFilter" class="form-control" onchange="renderRequests()">
          <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
          <option>Ø¬Ø¯ÙŠØ¯</option>
          <option>Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
          <option>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
          <option>Ù…Ø¹Ù„Ù‚</option>
          <option>Ù…ØºÙ„Ù‚</option>
          <option>Ù…Ø±ÙÙˆØ¶</option>
        </select>

        <label style="display:flex;align-items:center;gap:6px;font-size:14px;color:#455a64;">
          <input type="checkbox" id="showArchivedToggle" onchange="renderRequests()">
          Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¤Ø±Ø´ÙØ© ÙÙ‚Ø·
        </label>

        <button class="btn btn-outline" onclick="loadRequests()">
          <i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ«
        </button>

        <button class="btn btn-outline" onclick="exportRequestsCSV(false)">
          <i class="fas fa-file-export"></i> ØªØµØ¯ÙŠØ± (Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¸Ø§Ù‡Ø±Ø©)
        </button>

        <button class="btn btn-outline" onclick="exportRequestsCSV(true)">
          <i class="fas fa-download"></i> ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
        </button>
      </div>

      <div class="requests-grid" id="requestsContainer">
        <div class="no-requests">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
      </div>
    </div>

    <!-- === Users Tab === -->
    <div id="tab-users" class="tab">
      <div class="section-title"><i class="fas fa-database"></i> Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>

      <div class="filters">
        <input id="userSearch" class="form-control"
               placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… / Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ / Ø§Ù„Ù‚Ø³Ù… / Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©"
               oninput="renderUsers()">

        <select id="userStatusFilter" class="form-control" onchange="renderUsers()">
          <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
          <option value="Ù†Ø´Ø·">Ù†Ø´Ø·</option>
          <option value="Ù…Ø¤Ø±Ø´Ù">Ù…Ø¤Ø±Ø´Ù</option>
        </select>

        <button class="btn btn-primary" onclick="openUserModal()">
          <i class="fas fa-user-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…
        </button>

        <button class="btn btn-outline" onclick="exportUsersCSV()">
          <i class="fas fa-file-export"></i> ØªØµØ¯ÙŠØ± CSV
        </button>
      </div>

      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Ø§Ù„Ø§Ø³Ù…</th>
              <th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th>
              <th>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</th>
              <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
              <th>Ø§Ù„Ù‚Ø³Ù…</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th style="min-width:260px">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="usersBody">
            <tr><td colspan="7" class="no-requests">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- === Departments Tab === -->
    <div id="tab-departments" class="tab">
      <div class="section-title"><i class="fas fa-building"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</div>
      <div id="departmentsContent">
        <div class="no-requests">Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¨Ø¹Ø¯ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª...</div>
      </div>
    </div>
  </div>

  <!-- Modal: Add/Edit User -->
  <div class="modal" id="userModal">
    <div class="modal-content">
      <h3 id="userModalTitle" style="margin-bottom:10px;color:#1565c0">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</h3>
      <div class="row" style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div class="col" style="display:flex;flex-direction:column;gap:6px">
          <label>Ø§Ù„Ø§Ø³Ù…</label>
          <input id="u_name" class="form-control">
        </div>
        <div class="col" style="display:flex;flex-direction:column;gap:6px">
          <label>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</label>
          <input id="u_role" class="form-control" placeholder="Ù…ÙˆØ¸Ù / Ù…Ø¯ÙŠØ± Ù‚Ø³Ù… / Ù…Ø¯ÙŠØ± Ø¹Ø§Ù… / Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ© / admin">
        </div>
        <div class="col" style="display:flex;flex-direction:column;gap:6px">
          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
          <input id="u_password" class="form-control">
        </div>
        <div class="col" style="display:flex;flex-direction:column;gap:6px">
          <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
          <input id="u_email" class="form-control" placeholder="example@sevens.sa">
        </div>
        <div class="col" style="display:flex;flex-direction:column;gap:6px">
          <label>Ø§Ù„Ù‚Ø³Ù…</label>
          <input id="u_department" class="form-control">
        </div>
        <div class="col" style="display:flex;flex-direction:column;gap:6px">
          <label>Ø§Ù„Ø­Ø§Ù„Ø©</label>
          <select id="u_status" class="form-control">
            <option>Ù†Ø´Ø·</option>
            <option>Ù…Ø¤Ø±Ø´Ù</option>
          </select>
        </div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button class="btn btn-outline" onclick="closeUserModal()">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn btn-primary" onclick="saveUser()">Ø­ÙØ¸</button>
      </div>
    </div>
  </div>

  <!-- Modal: View User Details -->
  <div class="modal" id="userViewModal">
    <div class="modal-content">
      <h3 style="margin-bottom:10px;color:#1565c0">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h3>
      <div id="userViewBody"></div>
      <div style="display:flex;justify-content:flex-end;margin-top:12px;">
        <button class="btn btn-outline" onclick="closeUserViewModal()">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>

  <!-- Modal: Request Details -->
  <div class="modal" id="requestModal">
    <div class="modal-content" style="max-width:700px;">
      <h3 style="margin-bottom:10px;color:#1565c0">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h3>
      <div id="requestDetailsBody"></div>
      <div style="display:flex;gap:8px;justify-content:space-between;margin-top:12px;flex-wrap:wrap">
        <button class="btn btn-outline" onclick="exportSingleRequestToCSV()">
          <i class="fas fa-file-export"></i> ØªØµØ¯ÙŠØ± Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        </button>
        <div style="flex:1"></div>
        <button class="btn btn-outline" onclick="closeRequestModal()">Ø¥ØºÙ„Ø§Ù‚</button>
        <button class="btn btn-primary" onclick="loadRequestChat()">
          <i class="fas fa-comments"></i> Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
        </button>
      </div>
    </div>
  </div>

  <!-- Modal: Chat Log -->
  <div class="modal" id="chatModal">
    <div class="modal-content" style="max-width:700px;max-height:80vh;display:flex;flex-direction:column;">
      <h3 style="margin-bottom:10px;color:#1565c0">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</h3>
      <div id="chatBody" style="max-height:60vh;overflow-y:auto;margin:10px 0;"></div>
      <div style="display:flex;justify-content:flex-end;margin-top:10px;">
        <button class="btn btn-outline" onclick="closeChatModal()">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>

  <script>

      if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("/static/service-worker.js")
      .catch(err => console.log("SW failed", err));
  });
}
    /* ================== Utilities ================== */
    function normalizeArabicJS(t){
      t = (t||'').toString().trim();
      t = t.replace(/[\u200f\u200e]/g,'');
      t = t.replace(/[Ø¥Ø£Ø¢Ø§]/g,'Ø§');
      t = t.replace(/\s+/g,'');
      t = t.replace(/Ø©/g,'Ù‡');
      t = t.replace(/Ø§Ø¯Ø§Ø±Ø©|Ø¥Ø¯Ø§Ø±Ø©|Ø£Ø¯Ø§Ø±Ø©|Ø¢Ø¯Ø§Ø±Ø©|Ø§Ø¯Ø§Ø±Ù‡|Ø§Ù„Ø§Ø¯Ø§Ø±Ø©|Ø§Ù„Ø§Ø¯Ø§Ø±Ù‡/g,'Ø§Ø¯Ø§Ø±Ù‡');
      return t;
    }

    function showToast(msg, type="info"){
      const t=document.createElement('div');
      t.className=`toast show ${type}`;
      t.textContent=msg;
      document.body.appendChild(t);
      setTimeout(()=>t.remove(),3500);
    }

    function statusClass(s){
      if(!s) return 'status-in-progress';
      if(s.includes('Ø¬Ø¯ÙŠØ¯'))   return 'status-new';
      if(s.includes('Ù…ØºÙ„Ù‚'))   return 'status-closed';
      if(s.includes('Ø¬Ø§Ø±ÙŠ') || s.includes('Ù‚ÙŠØ¯'))   return 'status-in-progress';
      if(s.includes('Ù…Ø±ÙÙˆØ¶'))  return 'status-rejected';
      return 'status-in-progress';
    }

    function parseArchivedFlag(flag){
      if(flag === true) return true;
      if(flag === false || flag === 0) return false;
      if(flag == null) return false;
      const v = flag.toString().trim().toLowerCase();
      return (v === '1' || v === 'Ù†Ø¹Ù…' || v === 'yes' || v === 'true' || v === 'y');
    }

    function normalizeRole(rawRole){
      if(!rawRole) return 'employee';
      let role = rawRole.toString().trim().toLowerCase();

      // Ù„Ùˆ Ø¬Ø§ÙŠØ© Ø¬Ø§Ù‡Ø²Ø© Ù…Ù† Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯
      if(["admin","hr","general_manager","manager","employee"].includes(role)){
        return role;
      }

      const norm = str => str.replace(/[Ø¥Ø£Ø¢Ø§]/g, 'Ø§').replace(/Ø©/g,'Ù‡').replace(/\s+/g,'');

      const r = norm(rawRole.toString());

      if(r.includes('Ø§Ø¯Ù…Ù†') || r.includes('Ù…Ø´Ø±Ù') || r.includes('Ù†Ø¸Ø§Ù…')) return 'admin';
      if(r.includes('Ù…ÙˆØ§Ø±Ø¯') || r.includes('Ù…ÙˆØ§Ø±Ø¯Ø¨Ø´Ø±ÙŠÙ‡') || r.includes('hr')) return 'hr';
      if(r.includes('Ø¹Ø§Ù…')) return 'general_manager';
      if(r.includes('Ù‚Ø³Ù…') || r.includes('Ù…Ø¯ÙŠØ±Ù‚Ø³Ù…')) return 'manager';
      if(r.includes('Ù…ÙˆØ¸Ù')) return 'employee';

      return 'employee';
    }

    /* ================== State ================== */
    let currentUser = null;
    let allRequests = [];
    let allUsers    = [];
    let editingUserEmail = null;
    let currentRequestDetails = null;

    /* ================== Tabs ================== */
    function openTab(id, btn){
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
    }

    /* ================== Session Check & Init ================== */

    async function sessionCheck() {
      try {
        const res = await fetch("/api/auth/session_check");
        const data = await res.json();

        if (!data.valid) {
          localStorage.removeItem("sevens_user");
          window.location.href = "Login.html";
          return;
        }

        // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø© ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
        localStorage.setItem("sevens_user", JSON.stringify(data.user));
      } catch (e) {
        console.error("Session error:", e);
        localStorage.removeItem("sevens_user");
        window.location.href = "Login.html";
      }
    }

    async function initAdmin(){
      // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¬Ù„Ø³Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
      await sessionCheck();

      const saved = localStorage.getItem('sevens_user');
      if(!saved){
        location.href = 'Login.html';
        return;
      }

      try{
        currentUser = JSON.parse(saved);
      }catch(e){
        console.error(e);
        localStorage.removeItem('sevens_user');
        location.href='Login.html';
        return;
      }

      // ØªÙˆØ­ÙŠØ¯ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
      currentUser.role = normalizeRole(currentUser.role || '');

      // Ø§Ù„Ø³Ù…Ø§Ø­ ÙÙ‚Ø· Ù„Ù„Ø£Ø¯Ù…Ù†
      if(currentUser.role !== 'admin'){
        alert('Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù…Ø®ØµØµØ© Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·.');
        location.href = 'Login.html';
        return;
      }

      document.getElementById('userWelcome').textContent =
        `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${currentUser.name} (ØµÙ„Ø§Ø­ÙŠØ©: ${currentUser.role})`;

      await Promise.all([
        loadRequests(),
        loadUsers()
      ]);

      updateStatsBar();
      buildDepartmentsTab();

      // Ø¥Ø¹Ø§Ø¯Ø© ÙØ­Øµ Ø§Ù„Ø¬Ù„Ø³Ø© ÙƒÙ„ 20 Ø«Ø§Ù†ÙŠØ©
      setInterval(sessionCheck, 20000);
    }

    document.addEventListener('DOMContentLoaded', initAdmin);

    /* ================== Requests ================== */

    async function loadRequests(){
      const c = document.getElementById('requestsContainer');
      c.innerHTML = '<div class="no-requests">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';

      try{
        // API Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø£Ø¯Ù…Ù† â€“ Ù†ÙÙ‘Ø°Ù‡Ø§ ÙÙŠ app.py
        const res = await fetch('/api/admin/requests/list', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ include_archived:true })
        });
        const data = await res.json();
        allRequests = Array.isArray(data) ? data : [];
        renderRequests();
        updateStatsBar();
        buildDepartmentsTab();
      }catch(e){
        console.error(e);
        c.innerHTML = '<div class="no-requests">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>';
      }
    }

    function getFilteredRequests(){
      const q = (document.getElementById('reqSearch').value||'').toLowerCase().trim();
      const statusFilter    = document.getElementById('reqStatusFilter').value || '';
      const showArchivedOnly= document.getElementById('showArchivedToggle').checked;

      let list = allRequests.slice();

      list = list.map(r=>{
        const isArch = parseArchivedFlag(r['Ù…Ø¤Ø±Ø´Ù']);
        return {...r, __archived:isArch};
      });

      if(showArchivedOnly){
        list = list.filter(r=>r.__archived);
      }else{
        list = list.filter(r=>!r.__archived);
      }

      if(statusFilter){
        list = list.filter(r=>(r['Ø§Ù„Ø­Ø§Ù„Ø©']||'').includes(statusFilter));
      }

      if(q){
        list = list.filter(r=>{
          return [
            r['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨'],
            r['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†'],
            r['Ø§Ù„ÙˆØµÙ'],
            r['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„'],
            r['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…'],
            r['Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„'],
            r['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…']
          ].map(x=>(x||'').toString().toLowerCase()).some(v=>v.includes(q));
        });
      }

      return list;
    }

    function renderRequests(){
      const c = document.getElementById('requestsContainer');
      const list = getFilteredRequests();

      if(!list.length){
        c.innerHTML = '<div class="no-requests">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©.</div>';
        return;
      }

      c.innerHTML = list.map(req=>{
        const status   = (req['Ø§Ù„Ø­Ø§Ù„Ø©']||'').trim();
        const file     = req['Ø§Ù„Ù…Ù„Ù'] || '';
        const archived = !!req.__archived;

        const statusCls  = archived ? 'status-archived' : statusClass(status);
        const statusText = archived ? 'Ù…Ø¤Ø±Ø´Ù' : (status || '-');

        const reqId = (req['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨']||'').toString();

        return `
          <div class="request-card" data-id="${reqId}">
            <div class="status-header ${statusCls}"></div>
            <div class="card-content">
              <div style="display:flex;justify-content:space-between;color:#607d8b;font-size:13px">
                <div>#${reqId}</div>
                <div>${req['Ø§Ù„ØªØ§Ø±ÙŠØ®']||''} ${req['Ø§Ù„ÙˆÙ‚Øª']||''}</div>
              </div>

              <div class="request-title">${req['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†']||''}</div>
              <div style="color:#607d8b;margin:6px 0;max-height:60px;overflow:auto;">${req['Ø§Ù„ÙˆØµÙ']||''}</div>

              <div class="request-meta">
                <div><i class="fas fa-user"></i> Ø§Ù„Ù…Ø±Ø³Ù„: ${req['Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„']||'-'} (${req['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„']||'-'})</div>
                <div><i class="fas fa-user-check"></i> Ø§Ù„Ù…Ø³ØªÙ„Ù…: ${req['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…']||'-'} (${req['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…']||'-'})</div>
              </div>

              <div style="margin:8px 0;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                <span class="status-badge ${statusCls}">${statusText}</span>
                <span style="color:#78909c;font-size:13px;">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${req['Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« Ø¨ÙˆØ§Ø³Ø·Ø©']||'-'}</span>
                ${ archived ? '<span style="font-size:11px;color:#757575;background:#eeeeee;padding:2px 6px;border-radius:999px;">ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</span>' : '' }
              </div>

              <div style="margin:8px 0;">
                ${
                  file
                  ? `<a href="/uploads/${file}" target="_blank" class="btn btn-outline"><i class="fas fa-paperclip"></i> Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙÙ‚</a>`
                  : `<span style="color:#9e9e9e"><i class="fas fa-paperclip"></i> Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚</span>`
                }
              </div>

              <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn btn-outline" onclick="openRequestDetails('${reqId}')">
                  <i class="fas fa-eye"></i> ØªÙØ§ØµÙŠÙ„
                </button>
                ${
                  archived
                  ? `<button class="btn btn-green" onclick="unarchiveRequest('${reqId}')"><i class="fas fa-undo"></i> Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø·Ù„Ø¨</button>`
                  : `<button class="btn btn-danger" onclick="archiveRequest('${reqId}')"><i class="fas fa-box-archive"></i> Ø£Ø±Ø´ÙØ© Ø§Ù„Ø·Ù„Ø¨</button>`
                }
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    async function archiveRequest(reqId){
      if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø£Ø±Ø´ÙØ© Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ\nØ³ÙŠØ®ØªÙÙŠ Ù…Ù† ÙƒÙ„ Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ ÙˆÙ„Ø§ ÙŠØ¸Ù‡Ø± Ø¥Ù„Ø§ Ù…Ù† Ø®Ù„Ø§Ù„ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ "Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¤Ø±Ø´ÙØ©".')) return;

      try{
        const res = await fetch('/api/admin/requests/archive', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            request_id: reqId,
            archive: true,
            updated_by: currentUser.name
          })
        });
        const data = await res.json();
        if(data.success){
          showToast('ØªÙ…Øª Ø£Ø±Ø´ÙØ© Ø§Ù„Ø·Ù„Ø¨ âœ…','success');
          await loadRequests();
        }else{
          showToast('ÙØ´Ù„ ÙÙŠ Ø£Ø±Ø´ÙØ© Ø§Ù„Ø·Ù„Ø¨ âŒ','error');
        }
      }catch(e){
        console.error(e);
        showToast('ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…','error');
      }
    }

    async function unarchiveRequest(reqId){
      if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ø£Ø±Ø´ÙŠÙØŸ')) return;

      try{
        const res = await fetch('/api/admin/requests/archive', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            request_id: reqId,
            archive: false,
            updated_by: currentUser.name
          })
        });
        const data = await res.json();
        if(data.success){
          showToast('ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø·Ù„Ø¨ âœ…','success');
          await loadRequests();
        }else{
          showToast('ÙØ´Ù„ ÙÙŠ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø·Ù„Ø¨ âŒ','error');
        }
      }catch(e){
        console.error(e);
        showToast('ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…','error');
      }
    }

    function openRequestDetails(reqId){
      const req = allRequests.find(r => (r['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨']||'').toString() === reqId.toString());
      if(!req){
        showToast('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨','error');
        return;
      }
      currentRequestDetails = req;

      const archived = parseArchivedFlag(req['Ù…Ø¤Ø±Ø´Ù']);
      const status   = (req['Ø§Ù„Ø­Ø§Ù„Ø©']||'').trim();
      const statusText = archived ? 'Ù…Ø¤Ø±Ø´Ù' : (status || '-');

      const html = `
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;font-size:14px;">
          <div><strong>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</strong> ${req['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨']||''}</div>
          <div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${req['Ø§Ù„ØªØ§Ø±ÙŠØ®']||''}</div>
          <div><strong>Ø§Ù„ÙˆÙ‚Øª:</strong> ${req['Ø§Ù„ÙˆÙ‚Øª']||''}</div>
          <div><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${statusText}</div>
          <div><strong>Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„:</strong> ${req['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„']||''}</div>
          <div><strong>Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…:</strong> ${req['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…']||''}</div>
          <div><strong>Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø¹ÙŠÙ‘Ù†:</strong> ${req['Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø¹ÙŠÙ†']||'-'}</div>
          <div><strong>Ø¨Ø¯Ø£ Ø§Ù„ØªÙ†ÙÙŠØ° Ø¨ÙˆØ§Ø³Ø·Ø©:</strong> ${req['Ø¨Ø¯Ø£ Ø§Ù„ØªÙ†ÙÙŠØ° Ø¨ÙˆØ§Ø³Ø·Ø©']||'-'}</div>
          <div><strong>Ø£ØºÙ„Ù‚ Ø¨ÙˆØ§Ø³Ø·Ø©:</strong> ${req['Ø£ØºÙ„Ù‚ Ø¨ÙˆØ§Ø³Ø·Ø©']||'-'}</div>
          <div><strong>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« Ø¨ÙˆØ§Ø³Ø·Ø©:</strong> ${req['Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« Ø¨ÙˆØ§Ø³Ø·Ø©']||'-'}</div>
          <div><strong>Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„:</strong> ${req['Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„']||'-'}</div>
          <div><strong>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…:</strong> ${req['Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…']||'-'}</div>
        </div>
        <div style="margin-top:12px;font-size:14px;">
          <strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong>
          <div style="margin-top:4px;">${req['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†']||''}</div>
        </div>
        <div style="margin-top:12px;font-size:14px;">
          <strong>Ø§Ù„ÙˆØµÙ:</strong>
          <div style="margin-top:4px;white-space:pre-wrap;">${req['Ø§Ù„ÙˆØµÙ']||''}</div>
        </div>
        <div style="margin-top:12px;font-size:14px;">
          <strong>Ø§Ù„Ù…Ø±ÙÙ‚:</strong>
          ${
            req['Ø§Ù„Ù…Ù„Ù']
            ? `<a href="/uploads/${req['Ø§Ù„Ù…Ù„Ù']}" target="_blank" style="margin-right:4px;color:#1565c0;text-decoration:underline;"><i class="fas fa-paperclip"></i> ÙØªØ­ Ø§Ù„Ù…Ø±ÙÙ‚</a>`
            : `<span style="color:#9e9e9e">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚</span>`
          }
        </div>
      `;
      document.getElementById('requestDetailsBody').innerHTML = html;
      document.getElementById('requestModal').style.display = 'flex';
    }

    function closeRequestModal(){
      document.getElementById('requestModal').style.display = 'none';
    }

    async function loadRequestChat(){
      if(!currentRequestDetails){
        showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨ Ù…Ø­Ø¯Ø¯','error');
        return;
      }
      const reqId = currentRequestDetails['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨'];

      try{
        // Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø³Ø§Ø± Ø­Ø³Ø¨ Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯ Ø¹Ù†Ø¯Ùƒ Ù„Ùˆ Ù…Ø®ØªÙ„Ù
        const res = await fetch('/api/get_request_chat', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ request_id: reqId })
        });
        const data = await res.json();
        renderChat(Array.isArray(data) ? data : []);
      }catch(e){
        console.error(e);
        showToast('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©','error');
      }
    }

    function renderChat(messages){
      const container = document.getElementById('chatBody');
      if(!messages.length){
        container.innerHTML = '<div class="no-requests">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©.</div>';
      }else{
        container.innerHTML = messages.map(m=>{
          const sender = m.sender || m['Ø§Ù„Ù…Ø±Ø³Ù„'] || m['sender_name'] || '-';
          const dept   = m.department || m['Ø§Ù„Ù‚Ø³Ù…'] || '';
          const role   = m.role || m['role'] || '';
          const ts     = m.timestamp || m['Ø§Ù„ÙˆÙ‚Øª'] || m['time'] || '';
          const text   = m.message || m['Ø§Ù„Ø±Ø³Ø§Ù„Ø©'] || m['text'] || '';

          return `
            <div style="border:1px solid #e3f2fd;border-radius:10px;padding:8px 10px;margin-bottom:6px;">
              <div style="font-size:13px;color:#1565c0;font-weight:600;">
                ${sender}
                ${dept ? ` - <span style="color:#607d8b">${dept}</span>` : ''}
                ${role ? ` - <span style="color:#9e9e9e">${role}</span>` : ''}
              </div>
              <div style="font-size:12px;color:#9e9e9e;margin:3px 0 5px;">${ts}</div>
              <div style="font-size:14px;color:#37474f;white-space:pre-wrap;">${text}</div>
            </div>
          `;
        }).join('');
      }
      document.getElementById('chatModal').style.display='flex';
    }

    function closeChatModal(){
      document.getElementById('chatModal').style.display='none';
    }

    /* ===== ØªØµØ¯ÙŠØ± Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¥Ù„Ù‰ CSV ===== */

    function exportRequestsCSV(exportAll){
      const list = exportAll ? allRequests.slice() : getFilteredRequests();
      if(!list.length){
        showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§','info');
        return;
      }

      const headers = [
        'Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨','Ø§Ù„ØªØ§Ø±ÙŠØ®','Ø§Ù„ÙˆÙ‚Øª','Ø§Ù„Ø¹Ù†ÙˆØ§Ù†','Ø§Ù„ÙˆØµÙ',
        'Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„','Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…','Ø§Ù„Ø­Ø§Ù„Ø©','Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø¹ÙŠÙ†',
        'Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« Ø¨ÙˆØ§Ø³Ø·Ø©','Ø¨Ø¯Ø£ Ø§Ù„ØªÙ†ÙÙŠØ° Ø¨ÙˆØ§Ø³Ø·Ø©','Ø£ØºÙ„Ù‚ Ø¨ÙˆØ§Ø³Ø·Ø©',
        'Ø§Ù„Ù…Ù„Ù','Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„','Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…','Ù…Ø¤Ø±Ø´Ù'
      ];

      const rows = [];
      rows.push(headers.join(','));

      list.forEach(r=>{
        const row = headers.map(h=>{
          let v = r[h] != null ? r[h].toString() : '';
          v = v.replace(/"/g,'""');
          if(v.includes(',') || v.includes('\n')) v = `"${v}"`;
          return v;
        }).join(',');
        rows.push(row);
      });

      const blob = new Blob([rows.join('\n')], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const stamp = new Date().toISOString().slice(0,10);
      a.href = url;
      a.download = `sevens_requests_${exportAll ? 'all' : 'filtered'}_${stamp}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function exportSingleRequestToCSV(){
      if(!currentRequestDetails){
        showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨ Ù…Ø­Ø¯Ø¯','info');
        return;
      }
      exportRequestsCSV(false); // Ø£Ø¨Ø³Ø· Ø´ÙŠØ¡: ÙŠØµØ¯Ù‘Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¸Ø§Ù‡Ø±Ø© (ÙˆÙ‡Ùˆ Ù…Ù† Ø¶Ù…Ù†Ù‡Ø§)
      showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¸Ø§Ù‡Ø±Ø©ØŒ Ù…Ù† Ø¶Ù…Ù†Ù‡Ø§ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨','info');
    }

    /* ================== Users Management ================== */

    async function loadUsers(){
      try{
        const res = await fetch('/api/hr/list_users');
        const data = await res.json();
        allUsers = Array.isArray(data) ? data : [];
        renderUsers();
        buildDepartmentsTab();
      }catch(e){
        console.error('loadUsers error', e);
      }
    }

    function getFilteredUsers(){
      const q = (document.getElementById('userSearch').value||'').toLowerCase().trim();
      const statusFilter = document.getElementById('userStatusFilter').value || '';

      let list = allUsers.slice();

      if(statusFilter){
        list = list.filter(u=>(u['Ø§Ù„Ø­Ø§Ù„Ø©']||'').includes(statusFilter));
      }

      if(q){
        list = list.filter(u=>{
          return [
            u['Ø§Ù„Ø§Ø³Ù…'],
            u['Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ'],
            u['Ø§Ù„Ù‚Ø³Ù…'],
            u['Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©']
          ].map(x=>(x||'').toString().toLowerCase()).some(v=>v.includes(q));
        });
      }

      return list;
    }

    function renderUsers(){
      const body = document.getElementById('usersBody');
      const list = getFilteredUsers();

      if(!list.length){
        body.innerHTML = '<tr><td colspan="7" class="no-requests">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©</td></tr>';
        return;
      }

      body.innerHTML = list.map(u=>`
        <tr>
          <td>${u['Ø§Ù„Ø§Ø³Ù…']||''}</td>
          <td>${u['Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©']||''}</td>
          <td>${u['ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±']||''}</td>
          <td>${u['Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ']||''}</td>
          <td>${u['Ø§Ù„Ù‚Ø³Ù…']||''}</td>
          <td>${u['Ø§Ù„Ø­Ø§Ù„Ø©']||''}</td>
          <td class="action-btns">
            <button class="btn btn-outline" onclick="viewUser('${u['Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ']}')">
              <i class="fas fa-eye"></i> Ø¹Ø±Ø¶
            </button>
            <button class="btn btn-outline" onclick="editUser('${u['Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ']}')">
              <i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„
            </button>
            ${
              u['Ø§Ù„Ø­Ø§Ù„Ø©']==='Ù†Ø´Ø·'
              ? `<button class="btn btn-danger" onclick="archiveUser('${u['Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ']}')"><i class="fas fa-box-archive"></i> Ø£Ø±Ø´ÙØ©</button>`
              : `<button class="btn btn-green" onclick="unarchiveUser('${u['Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ']}')"><i class="fas fa-undo"></i> Ø§Ø³ØªØ±Ø¬Ø§Ø¹</button>`
            }
          </td>
        </tr>
      `).join('');
    }

    function openUserModal(){
      editingUserEmail = null;
      document.getElementById('userModalTitle').textContent = 'Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…';
      clearUserModal();
      document.getElementById('userModal').style.display = 'flex';
    }

    function closeUserModal(){
      document.getElementById('userModal').style.display = 'none';
    }

    function clearUserModal(){
      ['u_name','u_role','u_password','u_email','u_department'].forEach(id=>{
        document.getElementById(id).value = '';
      });
      document.getElementById('u_status').value = 'Ù†Ø´Ø·';
    }

    function editUser(email){
      const u = allUsers.find(x=>x['Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ']===email);
      if(!u) return;
      editingUserEmail = email;
      document.getElementById('userModalTitle').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù…';
      document.getElementById('u_name').value       = u['Ø§Ù„Ø§Ø³Ù…']||'';
      document.getElementById('u_role').value       = u['Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©']||'';
      document.getElementById('u_password').value   = u['ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±']||'';
      document.getElementById('u_email').value      = u['Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ']||'';
      document.getElementById('u_department').value = u['Ø§Ù„Ù‚Ø³Ù…']||'';
      document.getElementById('u_status').value     = u['Ø§Ù„Ø­Ø§Ù„Ø©']||'Ù†Ø´Ø·';
      document.getElementById('userModal').style.display = 'flex';
    }

    function viewUser(email){
      const u = allUsers.find(x=>x['Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ']===email);
      if(!u) return;

      const html = `
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;font-size:14px;">
          <div><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${u['Ø§Ù„Ø§Ø³Ù…']||''}</div>
          <div><strong>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</strong> ${u['Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ']||''}</div>
          <div><strong>Ø§Ù„Ù‚Ø³Ù…:</strong> ${u['Ø§Ù„Ù‚Ø³Ù…']||''}</div>
          <div><strong>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©:</strong> ${u['Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©']||''}</div>
          <div><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${u['Ø§Ù„Ø­Ø§Ù„Ø©']||''}</div>
          <div><strong>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</strong> ${u['ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±']||''}</div>
        </div>
      `;
      document.getElementById('userViewBody').innerHTML = html;
      document.getElementById('userViewModal').style.display = 'flex';
    }

    function closeUserViewModal(){
      document.getElementById('userViewModal').style.display = 'none';
    }

    async function saveUser(){
      const name = document.getElementById('u_name').value.trim();
      const role = document.getElementById('u_role').value.trim();
      const pass = document.getElementById('u_password').value.trim();
      const email= document.getElementById('u_email').value.trim();
      const dept = document.getElementById('u_department').value.trim();
      const status=document.getElementById('u_status').value.trim();

      if(!name || !role || !pass || !email || !dept){
        showToast('ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„','error');
        return;
      }

      const payload = {
        name: name,
        role: role,
        password: pass,
        email: email,
        department: dept,
        status: status
      };

      const url = editingUserEmail ? '/api/hr/update_user' : '/api/hr/add_user';

      try{
        const res = await fetch(url,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if(data.success){
          showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ âœ…','success');
          closeUserModal();
          loadUsers();
        }else{
          showToast('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ âŒ','error');
        }
      }catch(e){
        console.error(e);
        showToast('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…','error');
      }
    }

    async function archiveUser(email){
      if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø£Ø±Ø´ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ')) return;
      try{
        const res = await fetch('/api/hr/archive_user',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({email:email,status:'Ù…Ø¤Ø±Ø´Ù'})
        });
        const data = await res.json();
        if(data.success){
          showToast('ØªÙ…Øª Ø§Ù„Ø£Ø±Ø´ÙØ© âœ…','success');
          loadUsers();
        }else{
          showToast('ÙØ´Ù„ Ø§Ù„Ø£Ø±Ø´ÙØ© âŒ','error');
        }
      }catch(e){
        console.error(e);
        showToast('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…','error');
      }
    }

    async function unarchiveUser(email){
      if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ')) return;
      try{
        const res = await fetch('/api/hr/archive_user',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({email:email,status:'Ù†Ø´Ø·'})
        });
        const data = await res.json();
        if(data.success){
          showToast('ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© âœ…','success');
          loadUsers();
        }else{
          showToast('ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© âŒ','error');
        }
      }catch(e){
        console.error(e);
        showToast('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…','error');
      }
    }

    /* ===== ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¥Ù„Ù‰ CSV ===== */
    function exportUsersCSV(){
      const list = getFilteredUsers();
      if(!list.length){
        showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§','info');
        return;
      }

      const headers = ['Ø§Ù„Ø§Ø³Ù…','Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©','ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±','Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ','Ø§Ù„Ù‚Ø³Ù…','Ø§Ù„Ø­Ø§Ù„Ø©'];
      const rows = [];
      rows.push(headers.join(','));

      list.forEach(u=>{
        const row = headers.map(h=>{
          let v = u[h] != null ? u[h].toString() : '';
          v = v.replace(/"/g,'""');
          if(v.includes(',') || v.includes('\n')) v = `"${v}"`;
          return v;
        }).join(',');
        rows.push(row);
      });

      const blob = new Blob([rows.join('\n')], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const stamp = new Date().toISOString().slice(0,10);
      a.href = url;
      a.download = `sevens_users_filtered_${stamp}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    /* ================== Departments Tab ================== */

    function buildDepartmentsTab(){
      const container = document.getElementById('departmentsContent');
      if(!container) return;

      if(!allUsers.length && !allRequests.length){
        container.innerHTML = '<div class="no-requests">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</div>';
        return;
      }

      const map = new Map();

      // Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
      allUsers.forEach(u=>{
        const dep = (u['Ø§Ù„Ù‚Ø³Ù…'] || '').trim() || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        if(!map.has(dep)) map.set(dep,{users:0,sent:0,received:0});
        map.get(dep).users++;
      });

      // Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª
      allRequests.forEach(r=>{
        const senderDep   = (r['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„']   || '').trim() || null;
        const receiverDep = (r['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…'] || '').trim() || null;

        if(senderDep){
          if(!map.has(senderDep)) map.set(senderDep,{users:0,sent:0,received:0});
          map.get(senderDep).sent++;
        }

        if(receiverDep){
          if(!map.has(receiverDep)) map.set(receiverDep,{users:0,sent:0,received:0});
          map.get(receiverDep).received++;
        }
      });

      if(!map.size){
        container.innerHTML = '<div class="no-requests">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù….</div>';
        return;
      }

      const rows = [...map.entries()].sort((a,b)=>b[1].users - a[1].users);

      const html = `
        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>Ø§Ù„Ù‚Ø³Ù…</th>
                <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</th>
                <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµØ§Ø¯Ø±Ø©</th>
                <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</th>
              </tr>
            </thead>
            <tbody>
              ${
                rows.map(([dep,stats])=>`
                  <tr>
                    <td>${dep}</td>
                    <td>${stats.users}</td>
                    <td>${stats.sent}</td>
                    <td>${stats.received}</td>
                  </tr>
                `).join('')
              }
            </tbody>
          </table>
        </div>
      `;

      container.innerHTML = html;
    }

    /* ================== Stats Bar ================== */
    function updateStatsBar(){
      const bar = document.getElementById('statsBar');
      if(!bar) return;

      const total = allRequests.length;
      const newCount = allRequests.filter(r=>(r['Ø§Ù„Ø­Ø§Ù„Ø©']||'').includes('Ø¬Ø¯ÙŠØ¯')).length;
      const inProgress = allRequests.filter(r=>{
        const s = (r['Ø§Ù„Ø­Ø§Ù„Ø©']||'');
        return s.includes('Ø¬Ø§Ø±ÙŠ') || s.includes('Ù‚ÙŠØ¯');
      }).length;
      const closed = allRequests.filter(r=>(r['Ø§Ù„Ø­Ø§Ù„Ø©']||'').includes('Ù…ØºÙ„Ù‚')).length;
      const archived = allRequests.filter(r=>parseArchivedFlag(r['Ù…Ø¤Ø±Ø´Ù'])).length;

      bar.innerHTML = `
        <div class="stat-card">
          <div class="stat-label"><i class="fas fa-layer-group"></i> Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
          <div class="stat-value">${total}</div>
          <div class="stat-pill">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</div>
        </div>
        <div class="stat-card stat-card--new">
          <div class="stat-label"><i class="fas fa-star"></i> Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</div>
          <div class="stat-value">${newCount}</div>
          <div class="stat-pill">Ø­Ø§Ù„Ø©: Ø¬Ø¯ÙŠØ¯</div>
        </div>
        <div class="stat-card stat-card--progress">
          <div class="stat-label"><i class="fas fa-spinner"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ° / Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</div>
          <div class="stat-value">${inProgress}</div>
          <div class="stat-pill">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© / Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°</div>
        </div>
        <div class="stat-card stat-card--closed">
          <div class="stat-label"><i class="fas fa-check-circle"></i> Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØºÙ„Ù‚Ø©</div>
          <div class="stat-value">${closed}</div>
          <div class="stat-pill">Ù…ØºÙ„Ù‚</div>
        </div>
        <div class="stat-card stat-card--archived">
          <div class="stat-label"><i class="fas fa-box-archive"></i> Ø§Ù„Ù…Ø¤Ø±Ø´ÙØ©</div>
          <div class="stat-value">${archived}</div>
          <div class="stat-pill">Ù„Ø§ ØªØ¸Ù‡Ø± Ø¥Ù„Ø§ Ù‡Ù†Ø§</div>
        </div>
      `;
    }

    /* ================== Logout ================== */
    function logout(){
      if(confirm('ØªØ£ÙƒÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')){
        localStorage.removeItem('sevens_user');
        location.href='Login.html';
      }
    }
  </script>
</body>
</html>
