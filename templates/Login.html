<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ | SEVENS</title>
<!-- PWA -->
<link rel="manifest" href="/static/manifest.json">
<meta name="theme-color" content="#0B5ED7">

<!-- iOS Web App -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="SEVENS">

<link rel="apple-touch-icon" sizes="180x180" href="/static/icons/ios/180.png">
<link rel="apple-touch-icon" sizes="167x167" href="/static/icons/ios/167.png">
<link rel="apple-touch-icon" sizes="152x152" href="/static/icons/ios/152.png">
<link rel="apple-touch-icon" sizes="120x120" href="/static/icons/ios/120.png">

  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Tajawal',sans-serif; }

    body {
  margin:0;
  font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial;
  color:#0B1220;
  background:
    radial-gradient(1200px 600px at 80% 10%, rgba(11,94,215,.18), transparent 60%),
    radial-gradient(900px 500px at 10% 80%, rgba(10,62,154,.14), transparent 60%),
    #F7FAFF;
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:18px;
    padding-bottom: env(safe-area-inset-bottom);
}




    .login-container {
  background:#FFFFFF;
  width:100%;
  max-width:420px;
  padding:28px;
  border-radius:18px;
  box-shadow:0 14px 40px rgba(2,6,23,.12);
  text-align:center;
  border:1px solid rgba(15,23,42,.10);
    min-height: auto;
  -webkit-tap-highlight-color: transparent;
}


    .logo-box {
  width:72px;
  height:72px;
  margin:0 auto 18px;
  border-radius:18px;
  background:#fff;
  display:flex;
  justify-content:center;
  align-items:center;
  box-shadow:0 12px 30px rgba(11,94,215,.25);
    flex-shrink: 0;
}


    .logo-box img {
  width:48px;
  height:48px;
  object-fit:contain;
}


    .login-title {
  font-size:22px;
  font-weight:700;
  color:#0B1220;
  margin-bottom:14px;
}


    .input-field { margin-bottom:18px; position:relative; }
    .input-field input {
  width:100%;
  padding:12px 14px;
  border-radius:14px;
  border:1px solid rgba(15,23,42,.10);
  outline:none;
  font-size:14px;
  background:#fff;
}


    .input-field input:focus {
  border-color:rgba(11,94,215,.5);
  box-shadow:0 0 0 4px rgba(11,94,215,.12);
}


    .toggle-password {
  position:absolute;
  left:14px;
  top:50%;
  transform:translateY(-50%);
  font-size:16px;
  cursor:pointer;
  color:#0B5ED7;
}


    .btn-login {
  width:100%;
  margin-top:16px;
  padding:12px 14px;
  border:none;
  border-radius:14px;
  cursor:pointer;
  color:white;
  font-weight:700;
  font-size:15px;
  background:linear-gradient(180deg,#0B5ED7,#0A3E9A);
  box-shadow:0 12px 25px rgba(11,94,215,.22);
}



    .footer-links { margin-top:22px; font-size:14px; }
    .footer-links a { color:#1e88e5; text-decoration:none; font-weight:600; }

    /* Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªÙˆØ³Øª */
    .toast {
  position:fixed;
  bottom:25px;
  right:25px;
  padding:12px 16px;
  background:#0B1220;
  color:white;
  border-radius:12px;
  opacity:0;
  transform:translateY(20px);
  transition:.4s;
  z-index:9999;
  font-size:14px;
}

    .toast.show { opacity:1; transform:translateY(0); }

    /* Modal ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± */
    #forceResetModal {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.6);
      display:none; justify-content:center; align-items:center;
      z-index:9999;
    }
    .modal-box {
      background:white; padding:25px; width:90%; max-width:380px;
      border-radius:14px; text-align:center;
      box-shadow:0 5px 20px rgba(0,0,0,0.2);
    }

      /* ğŸ“± ØªØ­Ø³ÙŠÙ† Ù„Ù„Ø¬ÙˆØ§Ù„ */
@media (max-width: 480px) {
  .login-container {
    padding: 22px;
    border-radius: 16px;
  }

  .login-title {
    font-size: 20px;
  }

  .btn-login {
    font-size: 14px;
  }
}

  </style>
</head>

<body>

  <div class="login-container">

    <div class="logo-box">
      <img src="{{ url_for('static', filename='7s.jpg') }}">
    </div>

    <div class="login-title">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>

    <div class="input-field">
      <input type="email" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
    </div>

    <div class="input-field">
      <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
      <i class="fas fa-eye toggle-password" id="togglePassword"></i>
    </div>

    <button class="btn-login" id="loginBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>

    <div class="footer-links">
      <a href="ForgotYourPassword.html">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ</a>
    </div>
  </div>

  <!-- ğŸ”µ Ù†Ø§ÙØ°Ø© ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± -->
  <div id="forceResetModal">
    <div class="modal-box">
      <h3 style="color:#1e88e5;">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h3>
      <p>ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„.</p>

      <input id="newPass1" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©"
        style="width:100%; padding:10px; margin-top:12px; border:1px solid #ccc; border-radius:8px">

      <input id="newPass2" type="password" placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"
        style="width:100%; padding:10px; margin-top:10px; border:1px solid #ccc; border-radius:8px">

      <div id="resetError" style="color:#d32f2f; display:none; margin-top:10px;"></div>

      <button onclick="submitNewPassword()" style="
        margin-top:15px; padding:12px; width:100%;
        border:none; background:#1e88e5; color:white;
        font-size:16px; border-radius:8px; font-weight:700;
      ">Ø­ÙØ¸</button>
    </div>
  </div>

<script>

    if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("/static/service-worker.js")
      .catch(err => console.log("SW failed", err));
  });
}
  // =============== Toast Function =================
  function showToast(msg){
    const t = document.createElement("div");
    t.className = "toast show";
    t.innerText = msg;
    document.body.appendChild(t);
    setTimeout(()=>{ t.style.opacity=0; }, 2500);
    setTimeout(()=>{ t.remove(); }, 3200);
  }

  // =============== Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± =================
  document.getElementById("togglePassword").onclick = function(){
    const p = document.getElementById("password");
    p.type = (p.type === "password") ? "text" : "password";
    this.classList.toggle("fa-eye-slash");
  };

  // =============== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ =================
  document.getElementById("loginBtn").onclick = login;
  document.addEventListener("keydown", e => { if(e.key==="Enter") login(); });

  let loggedEmail = "";

  function login(){
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value.trim();

    if(!email || !password){
      showToast("ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„");
      return;
    }

    fetch("/api/login", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ email, password })
    })
    .then(res=>res.json())
    .then(data=>{

      if(!data.success){
        showToast(data.message || "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
        return;
      }

      const user = data.user;
      localStorage.setItem("sevens_user", JSON.stringify(user));

      // â­ Ù„Ùˆ required force reset
      if (user.force_reset === true || user.force_reset === "1" || user.force_reset === 1) {
        loggedEmail = user.email;
        document.getElementById("forceResetModal").style.display = "flex";
        return; // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙˆØ¬ÙŠÙ‡
      }

      // ================= ØªÙˆØ¬ÙŠÙ‡ Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ± ================
      const role = user.role || "";

      if (data.redirect){
        window.location.href = data.redirect;
      }
      else if (role === "Ù…ÙˆØ¸Ù"){
        window.location.href = "EmployeePage.html";
      }
      else if (role === "Ù…Ø¯ÙŠØ± Ù‚Ø³Ù…"){
        window.location.href = "DepartmentManagerPage.html";
      }
      else if (role === "Ù…Ø¯ÙŠØ± Ø¹Ø§Ù…"){
        window.location.href = "GeneralManager.html";
      }
      else if (role.includes("Ù…ÙˆØ§Ø±Ø¯")){
        window.location.href = "HrPage.html";
      }
      else {
        window.location.href = "EmployeePage.html";
      }
    })
    .catch(()=>{
      showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…");
    });
  }

  // =============== Ø¥Ø±Ø³Ø§Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø© =================
  function submitNewPassword(){
    const p1 = document.getElementById("newPass1").value.trim();
    const p2 = document.getElementById("newPass2").value.trim();
    const err = document.getElementById("resetError");

    if(!p1 || !p2){
      err.innerText = "Ø§Ù…Ù„Ø£ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„";
      err.style.display = "block";
      return;
    }
    if(p1 !== p2){
      err.innerText = "ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†";
      err.style.display = "block";
      return;
    }

    fetch("/api/force_reset_password", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ email: loggedEmail, newPassword: p1 })
    })
    .then(res=>res.json())
    .then(data=>{
      if(data.success){
        alert("ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±. Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
        location.href = "/Login.html";
      } else {
        err.innerText = data.message || "Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹";
        err.style.display = "block";
      }
    })
    .catch(()=>{
      err.innerText = "ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…";
      err.style.display = "block";
    });
  }


</script>

</body>
</html>
